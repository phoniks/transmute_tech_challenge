"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@sidetree/common"),r=require("@sidetree/core"),t=require("@sidetree/cas"),n=require("@sidetree/db"),o=function(){function o(e,i,s){var a=this;this.startPeriodicCachedBlockchainTimeRefresh=function(){setInterval((function(){try{return Promise.resolve(a.blockchain.getLatestTime())}catch(e){return Promise.reject(e)}}),1e3*o.cachedBlockchainTimeRefreshInSeconds)},this.versionManager=new r.VersionManager(e,i),this.operationStore=new n.OperationStore(e.mongoDbConnectionString,e.databaseName),this.blockchain=s,this.cas=new t.IpfsCasWithCache(e.contentAddressableStoreServiceUri,e.mongoDbConnectionString,e.databaseName),this.downloadManager=new r.DownloadManager(e.maxConcurrentDownloads,this.cas),this.resolver=new r.Resolver(this.versionManager,this.operationStore),this.batchScheduler=new r.BatchScheduler(this.versionManager,this.blockchain,e.batchingIntervalInSeconds),this.transactionStore=new n.MongoDbTransactionStore(e.mongoDbConnectionString,e.databaseName),this.unresolvableTransactionStore=new n.MongoDbUnresolvableTransactionStore(e.mongoDbConnectionString,e.databaseName),this.observer=new r.Observer(this.versionManager,this.blockchain,e.maxConcurrentDownloads,this.operationStore,this.transactionStore,this.unresolvableTransactionStore,e.observingIntervalInSeconds),this.serviceInfo=new r.ServiceInfo("core")}var i=o.prototype;return i.initialize=function(e,r){void 0===e&&(e=!0),void 0===r&&(r=!0);try{var t=this;return Promise.resolve(t.transactionStore.initialize()).then((function(){return Promise.resolve(t.unresolvableTransactionStore.initialize()).then((function(){return Promise.resolve(t.operationStore.initialize()).then((function(){return Promise.resolve(t.blockchain.initialize()).then((function(){return Promise.resolve(t.cas.initialize()).then((function(){return Promise.resolve(t.versionManager.initialize(t.blockchain,t.cas,t.downloadManager,t.operationStore,t.resolver,t.transactionStore)).then((function(){function n(){r&&t.batchScheduler.startPeriodicBatchWriting(),t.startPeriodicCachedBlockchainTimeRefresh(),t.downloadManager.start()}var o=function(){if(e)return Promise.resolve(t.observer.startPeriodicProcessing()).then((function(){}))}();return o&&o.then?o.then(n):n()}))}))}))}))}))}))}catch(e){return Promise.reject(e)}},i.triggerBatchWriting=function(){try{return Promise.resolve(this.batchScheduler.writeOperationBatch()).then((function(){}))}catch(e){return Promise.reject(e)}},i.triggerProcessTransactions=function(){try{var e=this;return Promise.resolve(e.observer.refreshLastKnownTransaction()).then((function(){return Promise.resolve(e.observer.processTransactions(!0)).then((function(){}))}))}catch(e){return Promise.reject(e)}},i.triggerBatchAndObserve=function(){try{var e=this;return Promise.resolve(e.triggerBatchWriting()).then((function(){return Promise.resolve(e.triggerProcessTransactions()).then((function(){}))}))}catch(e){return Promise.reject(e)}},i.close=function(){try{var e=function(){return Promise.resolve(r.transactionStore.close()).then((function(){return Promise.resolve(r.unresolvableTransactionStore.close()).then((function(){return Promise.resolve(r.operationStore.close()).then((function(){return Promise.resolve(r.observer.stopPeriodicProcessing()).then((function(){return Promise.resolve(r.cas.close()).then((function(){r.batchScheduler.stopPeriodicBatchWriting()}))}))}))}))}))},r=this,t=r.versionManager.getOperationQueue(r.blockchain.approximateTime.time),n=function(){if(t)return Promise.resolve(t.close()).then((function(){}))}();return Promise.resolve(n&&n.then?n.then(e):e())}catch(e){return Promise.reject(e)}},i.handleOperationRequest=function(e){try{var r=this.versionManager.getRequestHandler(this.blockchain.approximateTime.time).handleOperationRequest(e);return Promise.resolve(r)}catch(e){return Promise.reject(e)}},i.handleResolveRequest=function(e){try{var r=this.versionManager.getRequestHandler(this.blockchain.approximateTime.time).handleResolveRequest(e);return Promise.resolve(r)}catch(e){return Promise.reject(e)}},i.handleGetVersionRequest=function(){try{var r=this,t=r.serviceInfo.getServiceVersion();return Promise.resolve(r.blockchain.getServiceVersion()).then((function(n){return Promise.resolve(r.cas.getServiceVersion()).then((function(r){return{status:e.ResponseStatus.Succeeded,body:JSON.stringify([t,n,r])}}))}))}catch(e){return Promise.reject(e)}},o}();o.cachedBlockchainTimeRefreshInSeconds=60,exports.DidMethod=o;
//# sourceMappingURL=did-method.cjs.production.min.js.map
