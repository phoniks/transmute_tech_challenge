"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("@sidetree/common"),r=(e=require("multihashes"))&&"object"==typeof e&&"default"in e?e.default:e;function n(){return(n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var i=function(e,t){try{return Promise.resolve(new Promise((function(r,n){e.eth.getBlock(t,(function(e,t){e&&n(e),r(t)}))})))}catch(e){return Promise.reject(e)}},o=function(e,t){try{return Promise.all(t.map((function(t){try{return Promise.resolve(function(e,t){try{return Promise.resolve(i(e,t)).then((function(e){return e?e.timestamp:null}))}catch(e){return Promise.reject(e)}}(e,t.transactionTime)).then((function(e){return"number"==typeof e?n({},t,{transactionTimestamp:e}):t}))}catch(e){return Promise.reject(e)}})))}catch(e){return Promise.reject(e)}},s=function(e){return new Promise((function(t,r){e.eth.getAccounts((function(e,n){e&&r(e),t(n)}))}))},a=i,c=require("../package.json").version,u=require("@truffle/contract"),h=require("../build/contracts/SimpleSidetreeAnchor.json");exports.EthereumLedger=function(){function e(e,n,i){var a=this,m=this,f=this;this.web3=e,this.contractAddress=n,this.cachedBlockchainTime={hash:"",time:0},this.getServiceVersion=function(){return{name:"ethereum",version:c}},this._getTransactions=function(e,n,i){try{return Promise.resolve(a.getInstance()).then((function(s){return Promise.resolve(s.getPastEvents("Anchor",{fromBlock:e,toBlock:n||"latest",filter:i&&i.filter||void 0})).then((function(e){var n=e.map((function(e){return function(e){var n,i={anchorFileHash:(n=e.args.anchorFileHash,r.toB58String(r.fromHexString("1220"+n.replace("0x","")))),numberOfOperations:Number.parseInt(e.args.numberOfOperations)},o=t.AnchoredDataSerializer.serialize(i);return{transactionNumber:e.args.transactionNumber.toNumber(),transactionTime:e.blockNumber,transactionHash:e.transactionHash,transactionTimeHash:e.blockHash,anchorString:o,transactionFeePaid:0,normalizedTransactionFee:0,writer:"writer"}}(e)}));return i&&i.omitTimestamp?n:o(a.web3,n)}))}))}catch(e){return Promise.reject(e)}},this.extendSidetreeTransactionWithTimestamp=function(e){try{return Promise.resolve(o(m.web3,e))}catch(e){return Promise.reject(e)}},this.write=function(e,n){try{return Promise.resolve(s(f.web3)).then((function(n){var i=n[0],o=f.getInstance(),s=t.AnchoredDataSerializer.deserialize(e),a=s.numberOfOperations,c="0x"+r.toHexString(r.fromB58String(s.anchorFileHash)).substring(4),u=function(e,t){try{var r=Promise.resolve(o.anchorHash(c,a,{from:i})).then((function(e){f.logger.info("Ethereum transaction successful: https://ropsten.etherscan.io/tx/"+e.tx)}))}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}(0,(function(e){f.logger.error(e.message)}));if(u&&u.then)return u.then((function(){}))}))}catch(e){return Promise.reject(e)}},this.logger=i||console,this.anchorContract=u(h),this.anchorContract.setProvider(this.web3.currentProvider),this.anchorContract.defaults({gasPrice:"100000000000"})}var i,m=e.prototype;return m.initialize=function(){try{var e=this;return Promise.resolve(s(e.web3)).then((function(t){var r=t[0];function n(){return Promise.resolve(e.anchorContract.at(e.contractAddress)).then((function(t){return e.instance=t,Promise.resolve(e.getLatestTime()).then((function(){}))}))}var i=function(){if(!e.contractAddress)return Promise.resolve(e.anchorContract.new({from:r})).then((function(t){e.instance=t,e.contractAddress=e.instance.address,e.logger.info("Creating new Element contract at address "+e.contractAddress)}));e.logger.info("Using Element contract at address "+e.contractAddress)}();return i&&i.then?i.then(n):n()}))}catch(e){return Promise.reject(e)}},m.getInstance=function(){if(!this.instance)throw new Error("Contract instance is undefined. Call .initialize() first");return this.instance},m.read=function(e,t){try{var r,i=function(){return{moreTransactions:!1,transactions:r}},o=this,s={omitTimestamp:!0},c=function(){if(void 0!==e)return Promise.resolve(o._getTransactions(0,"latest",n({},s,{filter:{transactionNumber:[e]}}))).then((function(e){var t=function(){if(1===e.length)return Promise.resolve(o._getTransactions(e[0].transactionTime,"latest",s)).then((function(e){r=e}));r=[]}();if(t&&t.then)return t.then((function(){}))}));var i=t?Promise.resolve(a(o.web3,t)).then((function(e){var t=function(){if(e&&e.number)return Promise.resolve(o._getTransactions(e.number,e.number,s)).then((function(e){r=e}));r=[]}();if(t&&t.then)return t.then((function(){}))})):Promise.resolve(o._getTransactions(0,"latest",s)).then((function(e){r=e}));return i&&i.then?i.then((function(){})):void 0}();return Promise.resolve(c&&c.then?c.then(i):i())}catch(e){return Promise.reject(e)}},m.getLatestTime=function(){try{var e=this;return Promise.resolve(a(e.web3,"latest")).then((function(t){var r={time:t.number,hash:t.hash};return e.cachedBlockchainTime=r,r}))}catch(e){return Promise.reject(e)}},m.getFirstValidTransaction=function(e){try{return Promise.resolve(void 0)}catch(e){return Promise.reject(e)}},m.getFee=function(e){return Promise.resolve(0)},m.getValueTimeLock=function(e){return Promise.resolve(void 0)},m.getWriterValueTimeLock=function(){return Promise.resolve(void 0)},(i=[{key:"approximateTime",get:function(){return this.cachedBlockchainTime}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,i),e}();
//# sourceMappingURL=ethereum.cjs.production.min.js.map
