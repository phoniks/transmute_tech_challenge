"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var r=require("@sidetree/common"),t=e(require("ipfs-http-client")),o=e(require("it-concat")),n=require("@sidetree/db"),i=e(require("ipfs-unixfs")),c=require("ipld-dag-pb");"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var s=require("../package.json").version,u=function(){function e(e){this.getServiceVersion=function(){return{name:"ipfs",version:s}};var r=e.split("/");"ip4"===r[1]&&(this.ipfs=t({host:r[2],port:r[4]})),"dns4"===r[1]&&(this.ipfs=t({host:r[2],port:r[4],protocol:r[5]}))}var n=e.prototype;return n.initialize=function(){return Promise.resolve()},n.close=function(){return Promise.resolve()},n.write=function(e){try{return Promise.resolve(this.ipfs.add(e)).then((function(e){return Promise.resolve(e.next()).then((function(e){return e.value.path}))}))}catch(e){return Promise.reject(e)}},n.read=function(e){try{var t=this;return Promise.resolve(function(n,i){try{var c=(s=t.ipfs.get(e,{timeout:2e3}),Promise.resolve(s.next()).then((function(e){return Promise.resolve(o(e.value.content)).then((function(e){var t=e.copy();return t?{code:r.FetchResultCode.Success,content:t}:{code:r.FetchResultCode.NotFound}}))})))}catch(e){return i(e)}var s;return c&&c.then?c.then(void 0,i):c}(0,(function(e){if("TimeoutError"===e.name)return{code:r.FetchResultCode.NotFound};throw e})))}catch(e){return Promise.reject(e)}},e}(),a=require("../package.json").version,h=function(e){var t,o;function i(r,t,o){var i;return(i=e.call(this,r)||this).getServiceVersion=function(){return{name:"ipfs-with-cache",version:a}},i.cache=new n.MongoDbCasCache(t,o),i}o=e,(t=i).prototype=Object.create(o.prototype),t.prototype.constructor=t,t.__proto__=o;var c=i.prototype;return c.initialize=function(){try{return Promise.resolve(this.cache.initialize()).then((function(){}))}catch(e){return Promise.reject(e)}},c.close=function(){try{return Promise.resolve(this.cache.close()).then((function(){}))}catch(e){return Promise.reject(e)}},c.write=function(r){try{var t=this;return Promise.resolve(e.prototype.write.call(t,r)).then((function(e){return Promise.resolve(t.cache.write(e,r)).then((function(){return e}))}))}catch(e){return Promise.reject(e)}},c.read=function(t){try{var o=this;return Promise.resolve(o.cache.read(t)).then((function(n){return n.code===r.FetchResultCode.Success?(console.info("Returning cached content for address "+t),n):Promise.resolve(e.prototype.read.call(o,t)).then((function(e){var n=function(){if(e.code===r.FetchResultCode.Success)return console.info("Caching read result for "+t),Promise.resolve(o.cache.write(t,e.content)).then((function(){}))}();return n&&n.then?n.then((function(){return e})):e}))}))}catch(e){return Promise.reject(e)}},i}(u),f=require("../package.json").version,l=function(){function e(e){this.storage=new Map,this.mockSecondsTakenForEachCasFetch=0,void 0!==e&&(this.mockSecondsTakenForEachCasFetch=e)}var t=e.prototype;return t.getServiceVersion=function(){try{return Promise.resolve({name:"mock-cas",version:f})}catch(e){return Promise.reject(e)}},t.initialize=function(){return Promise.resolve()},t.close=function(){return Promise.resolve()},e.getAddress=function(e){try{var r=new i("file",e).marshal(),t=new c.DAGNode(r);return Promise.resolve(t.toDAGLink({cidVersion:0})).then((function(e){return e.Hash.toString()}))}catch(e){return Promise.reject(e)}},t.write=function(r){try{var t=this;return Promise.resolve(e.getAddress(r)).then((function(e){return t.storage.set(e,r),e}))}catch(e){return Promise.reject(e)}},t.read=function(e){try{var t=this;return Promise.resolve(new Promise((function(e){return setTimeout(e,1e3*t.mockSecondsTakenForEachCasFetch)}))).then((function(){var o=t.storage.get(e);return void 0===o?{code:r.FetchResultCode.NotFound}:{code:r.FetchResultCode.Success,content:o}}))}catch(e){return Promise.reject(e)}},e}();exports.IpfsCas=u,exports.IpfsCasWithCache=h,exports.MockCas=l;
//# sourceMappingURL=cas.cjs.production.min.js.map
