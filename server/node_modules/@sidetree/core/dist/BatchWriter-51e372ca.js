"use strict";var e=require("./index-0a641848.js"),r=require("@sidetree/common");require("fast-json-patch"),require("jose"),require("bip39"),require("@transmute/did-key-ed25519"),require("hdkey"),require("@trust/keyto"),require("@transmute/did-key-secp256k1"),require("time-span"),require("crypto");var t,o=require("./ValueTimeLockVerifier-849c26c7.js"),n=(t=require("chalk"))&&"object"==typeof t&&"default"in t?t.default:t,i=function(){};i.lightBlue=n.hex("#75b0eb"),i.green=n.green,i.yellow=n.yellow,exports.default=function(){function t(e,r,t,o){this.operationQueue=e,this.blockchain=r,this.cas=t,this.versionMetadataFetcher=o}var n=t.prototype;return n.write=function(){try{var t=this;return Promise.resolve(t.blockchain.getFee(t.blockchain.approximateTime.time)).then((function(n){return Promise.resolve(t.blockchain.getWriterValueTimeLock()).then((function(a){var u=t.getNumberOfOperationsAllowed(a);return Promise.resolve(t.operationQueue.peek(u)).then((function(u){var c=u.length;if(0!==u.length)return console.info(i.lightBlue("Batch size = "+i.green(""+c))),Promise.resolve(Promise.all(u.map((function(r){try{return Promise.resolve(e.Operation.parse(r.operationBuffer))}catch(e){return Promise.reject(e)}})))).then((function(l){var s=l.filter((function(e){return e.type===r.OperationType.Create})),f=l.filter((function(e){return e.type===r.OperationType.Recover})),h=l.filter((function(e){return e.type===r.OperationType.Update})),m=l.filter((function(e){return e.type===r.OperationType.Deactivate}));return Promise.resolve(e.ChunkFile.createBuffer(s,f,h)).then((function(l){return Promise.resolve(t.cas.write(l)).then((function(l){return console.info(i.lightBlue("Wrote chunk file "+i.green(l)+" to content addressable store.")),Promise.resolve(e.MapFile.createBuffer(l,h)).then((function(l){return Promise.resolve(t.cas.write(l)).then((function(l){return console.info(i.lightBlue("Wrote map file "+i.green(l)+" to content addressable store.")),Promise.resolve(e.AnchorFile.createBuffer(a?a.identifier:void 0,l,s,f,m)).then((function(e){return Promise.resolve(t.cas.write(e)).then((function(e){console.info(i.lightBlue("Wrote anchor file "+i.green(e)+" to content addressable store."));var a=r.AnchoredDataSerializer.serialize({anchorFileHash:e,numberOfOperations:c}),l=o.FeeManager.computeMinimumTransactionFee(n,c);return console.info(i.lightBlue("Writing data to blockchain: "+i.green(a)+" with minimum fee of: "+i.green(""+l))),Promise.resolve(t.blockchain.write(a,l)).then((function(){return Promise.resolve(t.operationQueue.dequeue(u.length)).then((function(){}))}))}))}))}))}))}))}))}));console.info("No queued operations to batch.")}))}))}))}catch(e){return Promise.reject(e)}},n.getNumberOfOperationsAllowed=function(e){var t=r.protocolParameters.maxOperationsPerBatch,n=o.ValueTimeLockVerifier.calculateMaxNumberOfOperationsAllowed(e,this.versionMetadataFetcher);return n>t&&console.info("Maximum number of operations allowed by value time lock: "+n+"; Maximum number of operations allowed by protocol: "+t),Math.min(n,t)},t}();
//# sourceMappingURL=BatchWriter-51e372ca.js.map
