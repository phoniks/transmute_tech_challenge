"use strict";var e=require("./index-0a641848.js"),r=require("@sidetree/common");require("fast-json-patch"),require("jose"),require("bip39"),require("@transmute/did-key-ed25519"),require("hdkey"),require("@trust/keyto"),require("@transmute/did-key-secp256k1"),require("time-span"),require("crypto");var t=require("./OperationProcessor-cefade7e.js"),o=require("url"),n=function(){function t(e,t){this.didMethodName=t;var o="did:"+t+":";if(!e.startsWith(o))throw new r.SidetreeError(r.ErrorCode.DidIncorrectPrefix);var n=e.indexOf("?");if(this.isShortForm=n<0,this.uniqueSuffix=this.isShortForm?e.substring(o.length):e.substring(o.length,n),0===this.uniqueSuffix.length)throw new r.SidetreeError(r.ErrorCode.DidNoUniqueSuffix);this.shortForm=o+this.uniqueSuffix}return t.create=function(e,o){try{var n=new t(e,o),i=function(){if(!n.isShortForm){var i=t.getInitialStateFromDidString(e,o);return Promise.resolve(t.constructCreateOperationFromInitialState(i)).then((function(e){if(!r.Multihash.isValidHash(e.encodedSuffixData,n.uniqueSuffix))throw new r.SidetreeError(r.ErrorCode.DidUniqueSuffixFromInitialStateMismatch);n.createOperation=e}))}}();return Promise.resolve(i&&i.then?i.then((function(e){return n})):n)}catch(e){return Promise.reject(e)}},t.getInitialStateFromDidString=function(n,i){var s=void 0;try{s=new o.URL(n)}catch(e){throw new r.SidetreeError(r.ErrorCode.DidInvalidDidString)}for(var a,u,d=i.split(":")[0],c=0,f=e._createForOfIteratorHelperLoose(s.searchParams);!(u=f()).done;){var l=u.value,p=l[0],h=l[1];if((c+=1)>1)throw new r.SidetreeError(r.ErrorCode.DidLongFormOnlyOneQueryParamAllowed);if(p!=="-"+d+"-"+t.initialStateParameterSuffix)throw new r.SidetreeError(r.ErrorCode.DidLongFormOnlyInitialStateParameterIsAllowed);a=h}if(void 0===a)throw new r.SidetreeError(r.ErrorCode.DidLongFormNoInitialStateFound);return a},t.constructCreateOperationFromInitialState=function(t){try{var o=t.indexOf(".");if(-1===o)throw new r.SidetreeError(r.ErrorCode.DidInitialStateValueContainsNoDot);if(t.lastIndexOf(".")!==o)throw new r.SidetreeError(r.ErrorCode.DidInitialStateValueContainsMoreThanOneDot);if(o===t.length-1||0===o)throw new r.SidetreeError(r.ErrorCode.DidInitialStateValueDoesNotContainTwoParts);var n=t.split("."),i={type:r.OperationType.Create,suffix_data:n[0],delta:n[1]},s=Buffer.from(JSON.stringify(i));return Promise.resolve(e.CreateOperation.parseObject(i,s,!1))}catch(e){return Promise.reject(e)}},t}();n.initialStateParameterSuffix="initial-state",exports.default=function(){function o(e,r,o){this.resolver=e,this.operationQueue=r,this.didMethodName=o,this.operationProcessor=new t.default}var i=o.prototype;return i.handleOperationRequest=function(t){try{var o,n=function(t){return i?t:e._catch((function(){function t(){var e=function(){if(n.status===r.ResponseStatus.Succeeded)return Promise.resolve(s.operationQueue.enqueue(o.didUniqueSuffix,o.operationBuffer)).then((function(){}))}();return e&&e.then?e.then((function(){return n})):n}var n;console.info("Operation type: '"+o.type+"', DID unique suffix: '"+o.didUniqueSuffix+"'");var i=e._switch(o.type,[[function(){return r.OperationType.Create},function(){return Promise.resolve(s.handleCreateRequest(o)).then((function(e){n=e}))}],[function(){return r.OperationType.Update}],[function(){return r.OperationType.Recover}],[function(){return r.OperationType.Deactivate},function(){n={status:r.ResponseStatus.Succeeded}}],[void 0,function(){n={status:r.ResponseStatus.BadRequest,body:{code:r.ErrorCode.RequestHandlerUnknownOperationType,message:"Unsupported operation type '"+o.type+"'."}}},function(){}]]);return i&&i.then?i.then(t):t()}),(function(e){return e instanceof r.SidetreeError?(console.info("Sidetree error: "+e.code+" "+e.message),{status:r.ResponseStatus.BadRequest,body:{code:e.code,message:e.message}}):(console.info("Unexpected error: "+e),{status:r.ResponseStatus.ServerError})}))},i=!1,s=this;console.info("Handling operation request of size "+t.length+" bytes...");var a=e._catch((function(){return Promise.resolve(e.JsonAsync.parse(t)).then((function(n){if(n.type===r.OperationType.Create||n.type===r.OperationType.Recover||n.type===r.OperationType.Update){var i=Buffer.from(n.delta);if(i.length>r.protocolParameters.maxDeltaSizeInBytes){var a="operationDdata byte size of "+i.length+" exceeded limit of "+r.protocolParameters.maxDeltaSizeInBytes;throw console.info(a),new r.SidetreeError(r.ErrorCode.RequestHandlerDeltaExceedsMaximumSize,a)}}return Promise.resolve(e.Operation.parse(t)).then((function(e){return o=e,Promise.resolve(s.operationQueue.contains(o.didUniqueSuffix)).then((function(e){if(e)throw new r.SidetreeError(r.ErrorCode.QueueingMultipleOperationsPerDidNotAllowed,"An operation request already exists in queue for DID '"+o.didUniqueSuffix+"', only one is allowed at a time.")}))}))}))}),(function(e){return e instanceof r.SidetreeError?(console.info("Bad request: "+e.code),console.info("Error message: "+e.message),i=!0,{status:r.ResponseStatus.BadRequest,body:{code:e.code,message:e.message}}):(console.info("Bad request: "+e),i=!0,{status:r.ResponseStatus.BadRequest})}));return Promise.resolve(a&&a.then?a.then(n):n(a))}catch(e){return Promise.reject(e)}},i.handleCreateRequest=function(t){try{var o=this;return Promise.resolve(o.applyCreateOperation(t)).then((function(n){if(void 0===n)return{status:r.ResponseStatus.BadRequest,body:"Invalid create operation."};var i=e.DocumentComposer.transformToExternalDocument(n,"did:"+o.didMethodName+":"+t.didUniqueSuffix);return{status:r.ResponseStatus.Succeeded,body:i}}))}catch(e){return Promise.reject(e)}},i.handleResolveRequest=function(t){try{var o=this;return Promise.resolve(e._catch((function(){return console.info("Handling resolution request for: "+t+"..."),Promise.resolve(n.create(t,o.didMethodName)).then((function(n){function i(){if(void 0===s)return{status:r.ResponseStatus.NotFound};var o=e.DocumentComposer.transformToExternalDocument(s,t);return{status:r.ResponseStatus.Succeeded,body:o}}var s,a=n.isShortForm?Promise.resolve(o.resolver.resolve(n.uniqueSuffix)).then((function(e){s=e})):Promise.resolve(o.resolveLongFormDid(n)).then((function(e){s=e}));return a&&a.then?a.then(i):i()}))}),(function(e){return e instanceof r.SidetreeError?{status:r.ResponseStatus.BadRequest,body:{code:e.code,message:e.message}}:(console.info("Unexpected error: "+e),{status:r.ResponseStatus.ServerError})})))}catch(e){return Promise.reject(e)}},i.resolveLongFormDid=function(e){try{var r=this;return Promise.resolve(r.resolver.resolve(e.uniqueSuffix)).then((function(t){return void 0!==t?t:Promise.resolve(r.applyCreateOperation(e.createOperation)).then((function(e){return t=e}))}))}catch(e){return Promise.reject(e)}},i.applyCreateOperation=function(e){try{return Promise.resolve(this.operationProcessor.apply({didUniqueSuffix:e.didUniqueSuffix,type:r.OperationType.Create,transactionTime:0,transactionNumber:0,operationIndex:0,operationBuffer:e.operationBuffer},void 0))}catch(e){return Promise.reject(e)}},o}();
//# sourceMappingURL=RequestHandler-5cc027b8.js.map
