"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function r(e){if(e&&e.__esModule)return e;var r={};return e&&Object.keys(e).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})})),r.default=e,r}var t=require("@sidetree/common"),n=e(require("fast-json-patch")),o=require("jose"),i=require("bip39"),a=require("@transmute/did-key-ed25519"),s=e(require("hdkey")),c=require("@trust/keyto"),u=require("@transmute/did-key-secp256k1"),d=e(require("time-span")),f=require("crypto");const h=function(){function e(){}return e.prototype.then=function(r,t){const n=new e,o=this.s;if(o){const e=1&o?r:t;if(e){try{p(n,1,e(this.v))}catch(e){p(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?p(n,1,r?r(o):o):t?p(n,1,t(o)):p(n,2,o)}catch(e){p(n,2,e)}},n},e}();function p(e,r,t){if(!e.s){if(t instanceof h){if(!t.s)return void(t.o=p.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(p.bind(null,e,r),p.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}function l(e){return e instanceof h&&1&e.s}function v(e,r,t){var n,o,i=-1;return function a(s){try{for(;++i<e.length&&(!t||!t());)if((s=r(i))&&s.then){if(!l(s))return void s.then(a,o||(o=p.bind(null,n=new h,2)));s=s.v}n?p(n,1,s):n=s}catch(e){p(n||(n=new h),2,e)}}(),n}const m="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function y(e,r,t){if("function"==typeof e[m]){var n,o,i,a=e[m]();if(function e(s){try{for(;!((n=a.next()).done||t&&t());)if((s=r(n.value))&&s.then){if(!l(s))return void s.then(e,i||(i=p.bind(null,o=new h,2)));s=s.v}o?p(o,1,s):o=s}catch(e){p(o||(o=new h),2,e)}}(),a.return){var s=function(e){try{n.done||a.return()}catch(e){}return e};if(o&&o.then)return o.then(s,(function(e){throw s(e)}));s()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var c=[],u=0;u<e.length;u++)c.push(e[u]);return v(c,(function(e){return r(c[e])}),t)}function P(e,r,t){for(var n;;){var o=e();if(l(o)&&(o=o.v),!o)return i;if(o.then){n=0;break}var i=t();if(i&&i.then){if(!l(i)){n=1;break}i=i.s}if(r){var a=r();if(a&&a.then&&!l(a)){n=2;break}}}var s=new h,c=p.bind(null,s,2);return(0===n?o.then(d):1===n?i.then(u):a.then(f)).then(void 0,c),s;function u(n){i=n;do{if(r&&(a=r())&&a.then&&!l(a))return void a.then(f).then(void 0,c);if(!(o=e())||l(o)&&!o.v)return void p(s,1,i);if(o.then)return void o.then(d).then(void 0,c);l(i=t())&&(i=i.v)}while(!i||!i.then);i.then(u).then(void 0,c)}function d(e){e?(i=t())&&i.then?i.then(u).then(void 0,c):u(i):p(s,1,i)}function f(){(o=e())?o.then?o.then(d).then(void 0,c):d(o):p(s,1,i)}}function g(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}function w(e,r){try{var t=e()}catch(e){return r(!0,e)}return t&&t.then?t.then(r.bind(null,!1),r.bind(null,!0)):r(!1,t)}function S(){return(S=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function E(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function b(e,r){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return E(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?E(e,void 0):void 0}}(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var O=function(){function e(){}return e.hasDuplicates=function(e){for(var r=new Set,t=0;t<e.length;t++){var n=e[t];if(r.has(n))return!0;r.add(n)}return!1},e.areMutuallyExclusive=function(e,r){for(var t,n=new Set(e),o=b(r);!(t=o()).done;)if(n.has(t.value))return!1;return!0},e}(),C=require("pako"),k=function(){function e(){}return e.compress=function(e){try{var r=C.deflate(Buffer.from(e));return Promise.resolve(Buffer.from(r))}catch(e){return Promise.reject(e)}},e.decompress=function(e){try{var r=C.inflate(e);return Promise.resolve(Buffer.from(r))}catch(e){return Promise.reject(e)}},e}(),D=function(){function e(){}return e.transformToExternalDocument=function(e,r){if(void 0===e.nextRecoveryCommitmentHash)return{status:"deactivated"};var n=e.document,o=r.split("?")[0],i=[],a=[],s=[],c=[],u=[],d=[];if(Array.isArray(n.public_keys))for(var f,h=b(n.public_keys);!(f=h()).done;){var p=f.value,l="#"+p.id,v={id:l,controller:o,type:p.type,publicKeyJwk:p.jwk},m=new Set(p.purpose);m.has(t.PublicKeyPurpose.General)?(d.push(v),m.has(t.PublicKeyPurpose.Auth)&&i.push(l),m.has(t.PublicKeyPurpose.AssertionMethod)&&a.push(l),m.has(t.PublicKeyPurpose.CapabilityInvocation)&&s.push(l),m.has(t.PublicKeyPurpose.CapabilityDelegation)&&c.push(l),m.has(t.PublicKeyPurpose.KeyAgreement)&&u.push(l)):m.has(t.PublicKeyPurpose.Auth)?i.push(v):m.has(t.PublicKeyPurpose.AssertionMethod)?a.push(a):m.has(t.PublicKeyPurpose.CapabilityInvocation)?s.push(v):m.has(t.PublicKeyPurpose.CapabilityDelegation)?c.push(v):m.has(t.PublicKeyPurpose.KeyAgreement)&&u.push(v)}var y=[];if(Array.isArray(n.service_endpoints))for(var P,g=b(n.service_endpoints);!(P=g()).done;){var w=P.value;y.push({id:"#"+w.id,type:w.type,serviceEndpoint:w.endpoint})}var S={id:o,"@context":["https://www.w3.org/ns/did/v1",{"@base":o}]};return 0!==d.length&&(S.publicKey=d),0!==i.length&&(S.authentication=i),0!==a.length&&(S.assertionMethod=a),0!==s.length&&(S.capabilityInvocation=s),0!==c.length&&(S.capabilityDelegation=c),0!==u.length&&(S.keyAgreement=u),0!==y.length&&(S.service=y),JSON.parse(JSON.stringify({"@context":"https://www.w3.org/ns/did-resolution/v1",didDocument:S,methodMetadata:{recoveryCommitment:e.nextRecoveryCommitmentHash,updateCommitment:e.nextUpdateCommitmentHash}}))},e.applyUpdateOperation=function(r,t){try{var n=e.applyPatches(t,r.delta.patches);return Promise.resolve(n)}catch(e){return Promise.reject(e)}},e.validateDocument=function(r){if(void 0===r)throw new t.SidetreeError(t.ErrorCode.DocumentComposerDocumentMissing);var n=new Set(["public_keys","service_endpoints"]);for(var o in r)if(!n.has(o))throw new t.SidetreeError(t.ErrorCode.DocumentComposerUnknownPropertyInDocument,"Unexpected property "+o+" in document.");Object.prototype.hasOwnProperty.call(r,"public_keys")&&e.validatePublicKeys(r.public_keys),Object.prototype.hasOwnProperty.call(r,"service_endpoints")&&e.validateServiceEndpoints(r.service_endpoints)},e.validateDocumentPatches=function(r){if(!Array.isArray(r))throw new t.SidetreeError(t.ErrorCode.DocumentComposerUpdateOperationDocumentPatchesNotArray);for(var n,o=b(r);!(n=o()).done;)e.validatePatch(n.value)},e.validatePatch=function(r){switch(r.action){case"replace":e.validateDocument(r.document);break;case"add-public-keys":e.validateAddPublicKeysPatch(r);break;case"remove-public-keys":e.validateRemovePublicKeysPatch(r);break;case"add-service-endpoints":e.validateAddServiceEndpointsPatch(r);break;case"remove-service-endpoints":e.validateRemoveServiceEndpointsPatch(r);break;case"ietf-json-patch":e.validateIetfJsonPatch(r);break;default:throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownAction)}},e.validateIetfJsonPatch=function(e){if(2!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);var r=n.validate(e.patches);if(r)throw console.warn(r),new t.SidetreeError(r.name)},e.validateAddPublicKeysPatch=function(r){if(2!==Object.keys(r).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);e.validatePublicKeys(r.public_keys)},e.validatePublicKeys=function(r){if(!Array.isArray(r))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeysNotArray);for(var n,o=new Set,i=b(r);!(n=i()).done;){var a=n.value;if(4!==Object.keys(a).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyMissingOrUnknownProperty);if("object"!=typeof a.jwk||Array.isArray(a.jwk))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyJwkMissingOrIncorrectType);if("string"!=typeof a.type)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyTypeMissingOrIncorrectType);if(e.validateId(a.id),o.has(a.id))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyIdDuplicated);if(o.add(a.id),!Array.isArray(a.purpose)||0===a.purpose.length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyPurposeMissingOrUnknown);if(a.purpose.length>Object.values(t.PublicKeyPurpose).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyPurposeExceedsMaxLength);for(var s,c=new Set(Object.values(t.PublicKeyPurpose)),u=b(a.purpose);!(s=u()).done;)if(!c.has(s.value))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyInvalidPurpose)}},e.validateRemovePublicKeysPatch=function(e){if(2!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);if(!Array.isArray(e.public_keys))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchPublicKeyIdsNotArray);for(var r,n=b(e.public_keys);!(r=n()).done;)if("string"!=typeof r.value)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchPublicKeyIdNotString)},e.validateRemoveServiceEndpointsPatch=function(r){if(2!==Object.keys(r).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);if(!Array.isArray(r.ids))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointIdsNotArray);for(var n,o=b(r.ids);!(n=o()).done;)e.validateId(n.value)},e.validateAddServiceEndpointsPatch=function(r){if(2!==Object.keys(r).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);if(!Array.isArray(r.service_endpoints))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointsNotArray);e.validateServiceEndpoints(r.service_endpoints)},e.validateServiceEndpoints=function(r){if(!Array.isArray(r))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointsNotArray);for(var n,o=b(r);!(n=o()).done;){var i=n.value;if(3!==Object.keys(i).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerServiceEndpointMissingOrUnknownProperty);if(e.validateId(i.id),"string"!=typeof i.type)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointTypeNotString);if(i.type.length>30)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointTypeTooLong);if("string"!=typeof i.endpoint)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointServiceEndpointNotString);if(i.endpoint.length>100)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointServiceEndpointTooLong);try{new URL(i.endpoint)}catch(e){throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointServiceEndpointNotValidUrl)}}},e.validateId=function(e){if("string"!=typeof e)throw new t.SidetreeError(t.ErrorCode.DocumentComposerIdNotString,"ID not string: "+JSON.stringify(e)+" is of type '"+typeof e+"'");if(e.length>50)throw new t.SidetreeError(t.ErrorCode.DocumentComposerIdTooLong);if(!t.Encoder.isBase64UrlString(e))throw new t.SidetreeError(t.ErrorCode.DocumentComposerIdNotUsingBase64UrlCharacterSet)},e.applyPatches=function(r,t){for(var n,o=r,i=b(t);!(n=i()).done;)o=e.applyPatchToDidDocument(o,n.value);return o},e.applyPatchToDidDocument=function(r,t){return"replace"===t.action?t.document:"add-public-keys"===t.action?e.addPublicKeys(r,t):"remove-public-keys"===t.action?e.removePublicKeys(r,t):"add-service-endpoints"===t.action?e.addServiceEndpoints(r,t):"remove-service-endpoints"===t.action?e.removeServiceEndpoints(r,t):"ietf-json-patch"===t.action?e.applyIetfJsonPatch(r,t):void 0},e.applyIetfJsonPatch=function(e,r){return n.applyPatch(S({},e),r.patches).newDocument},e.addPublicKeys=function(e,r){for(var t,n=new Map((e.public_keys||[]).map((function(e){return[e.id,e]}))),o=b(r.public_keys);!(t=o()).done;){var i=t.value;n.set(i.id,i)}return e.public_keys=Array.from(n.entries()).map((function(e){return e[1]})),e},e.removePublicKeys=function(e,r){for(var t,n=new Map((e.public_keys||[]).map((function(e){return[e.id,e]}))),o=b(r.public_keys);!(t=o()).done;){var i=t.value;void 0!==n.get(i)&&n.delete(i)}return e.public_keys=Array.from(n.entries()).map((function(e){return e[1]})),e},e.addServiceEndpoints=function(e,r){var t=r.service_endpoints;void 0===e.service_endpoints&&(e.service_endpoints=[]);var n=new Map;for(var o in e.service_endpoints)n.set(e.service_endpoints[o].id,o);for(var i,a=b(t);!(i=a()).done;){var s=i.value;if(n.has(s.id)){var c=n.get(s.id);e.service_endpoints[c]=s}else e.service_endpoints.push(s)}return e},e.removeServiceEndpoints=function(e,r){if(void 0===e.service_endpoints)return e;var t=new Set(r.ids);return e.service_endpoints=e.service_endpoints.filter((function(e){return!t.has(e.id)})),e},e}(),T=require("yieldable-json"),j=function(){function e(){}return e.parse=function(e){try{var r=new Promise((function(r,t){T.parseAsync(e,(function(e,n){e?t(e):r(n)}))}));return Promise.resolve(r)}catch(e){return Promise.reject(e)}},e}(),M=function(){function e(){}return e.parseDelta=function(e){try{if("string"!=typeof e)throw new t.SidetreeError(t.ErrorCode.DeltaMissingOrNotString);var r=t.Encoder.decodeAsString(e);return Promise.resolve(j.parse(r)).then((function(e){if(2!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.DeltaMissingOrUnknownProperty);if(void 0===e.patches)throw new t.SidetreeError(t.ErrorCode.OperationDocumentPatchesMissing);D.validateDocumentPatches(e.patches);var r=t.Encoder.decodeAsBuffer(e.update_commitment);return t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(r),{patches:e.patches,update_commitment:e.update_commitment}}))}catch(e){return Promise.reject(e)}},e}(),x=function(){function e(e,r,n,o,i,a){this.didUniqueSuffix=r,this.type=t.OperationType.Create,this.operationBuffer=e,this.encodedSuffixData=n,this.suffixData=o,this.encodedDelta=i,this.delta=a}return e.computeDidUniqueSuffix=function(e){var r=t.Encoder.decodeAsBuffer(e),n=t.Multihash.hash(r);return t.Encoder.encode(n)},e.parseOperationFromAnchorFile=function(r){try{var t=Buffer.from(JSON.stringify(r));return Promise.resolve(e.parseObject(r,t,!0))}catch(e){return Promise.reject(e)}},e.parse=function(r){try{var t=r.toString();return Promise.resolve(j.parse(t)).then((function(t){return Promise.resolve(e.parseObject(t,r,!1))}))}catch(e){return Promise.reject(e)}},e.parseObject=function(r,n,o){try{var i=3;if(o&&(i=1),Object.keys(r).length!==i)throw new t.SidetreeError(t.ErrorCode.CreateOperationMissingOrUnknownProperty);var a=r.suffix_data;return Promise.resolve(e.parseSuffixData(a)).then((function(i){function s(t){var o=e.computeDidUniqueSuffix(r.suffix_data);return new e(n,o,a,i,c,u)}var c=void 0,u=void 0,d=function(){if(!o){if(r.type!==t.OperationType.Create)throw new t.SidetreeError(t.ErrorCode.CreateOperationTypeIncorrect);c=r.delta;var e=g((function(){return Promise.resolve(M.parseDelta(r.delta)).then((function(e){u=e}))}),(function(){}));if(e&&e.then)return e.then((function(){}))}}();return d&&d.then?d.then(s):s()}))}catch(e){return Promise.reject(e)}},e.parseSuffixData=function(e){try{if("string"!=typeof e)throw new t.SidetreeError(t.ErrorCode.CreateOperationSuffixDataMissingOrNotString);var r=t.Encoder.decodeAsString(e);return Promise.resolve(j.parse(r)).then((function(e){if(2!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.CreateOperationSuffixDataMissingOrUnknownProperty);var r=t.Encoder.decodeAsBuffer(e.delta_hash),n=t.Encoder.decodeAsBuffer(e.recovery_commitment);return t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(r),t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(n),{delta_hash:e.delta_hash,recovery_commitment:e.recovery_commitment}}))}catch(e){return Promise.reject(e)}},e}(),_=function(){function e(){}return e.generateEd25519KeyPair=function(){try{return Promise.resolve(o.JWK.generate("OKP","Ed25519")).then((function(e){var r=e.toJWK(!0);return[e.toJWK(!1),r]}))}catch(e){return Promise.reject(e)}},e.getBufferAtIndex=function(e,r){try{return Promise.resolve(i.mnemonicToSeed(e)).then((function(e){return s.fromMasterSeed(e).derive("m/44'/60'/0'/0/"+r).privateKey}))}catch(e){return Promise.reject(e)}},e.generateEd25519KeyPairFromMnemonic=function(r,t){try{return Promise.resolve(e.getBufferAtIndex(r,t)).then((function(e){return Promise.resolve(a.Ed25519KeyPair.generate({seed:e})).then((function(e){var r=new a.Ed25519KeyPair(e);return Promise.resolve(r.toJwk(!1)).then((function(e){return Promise.resolve(r.toJwk(!0)).then((function(r){return[e,r]}))}))}))}))}catch(e){return Promise.reject(e)}},e.generateSecp256k1KeyPair=function(){try{return Promise.resolve(o.JWK.generate("EC","secp256k1")).then((function(e){return[e.toJWK(!1),e.toJWK(!0)]}))}catch(e){return Promise.reject(e)}},e.generateJwkKeyPairFromMnemonic=function(e,r,t){try{switch(e){case"secp256k1":return Promise.resolve(this.generateSecp256k1KeyPairFromMnemonic(r,t));case"ed25519":return Promise.resolve(this.generateEd25519KeyPairFromMnemonic(r,t));default:throw new Error("Invalid key type")}}catch(e){return Promise.reject(e)}},e.generateSecp256k1KeyPairFromMnemonic=function(r,t){try{return Promise.resolve(e.getBufferAtIndex(r,t)).then((function(e){var r=c.from(e,"blk").toJwk("public");r.crv="secp256k1";var t=c.from(e,"blk").toJwk("private");return t.crv="secp256k1",[r,t]}))}catch(e){return Promise.reject(e)}},e.validatePublicJwk=function(e){if(void 0===e)throw new t.SidetreeError(t.ErrorCode.JwkUndefined);var r=new Set(["kty","crv","x","y","kid"]);for(var n in e)if(!r.has(n))throw new t.SidetreeError(t.ErrorCode.JwkHasUnknownProperty);switch(e.crv){case"Ed25519":if("OKP"!==e.kty)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidKty);if("string"!=typeof e.x)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidTypeX);break;case"secp256k1":if("EC"!==e.kty)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidKty);if("string"!=typeof e.x)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidTypeX);if("string"!=typeof e.y)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidTypeY);break;default:throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidCrv)}},e.getCurve25519PublicKey=function(e){var r=Object.assign({},e);return delete r.d,r},e}(),A=function(){function e(e){if("string"!=typeof e)throw new t.SidetreeError(t.ErrorCode.JwsCompactJwsNotString);var r=e.split(".");if(3!==r.length)throw new t.SidetreeError(t.ErrorCode.JwsCompactJwsInvalid);var n=r[0],o=r[1],i=r[2],a=t.Encoder.decodeBase64UrlAsString(n),s=JSON.parse(a);if(1!==Object.keys(s).length)throw new t.SidetreeError(t.ErrorCode.JwsProtectedHeaderMissingOrUnknownProperty);if("EdDSA"!==s.alg&&"ES256K"!==s.alg)throw new t.SidetreeError(t.ErrorCode.JwsProtectedHeaderMissingOrIncorrectAlg);if(!t.Encoder.isBase64UrlString(i))throw new t.SidetreeError(t.ErrorCode.JwsSignatureNotBase64UrlString);if(!t.Encoder.isBase64UrlString(o))throw new t.SidetreeError(t.ErrorCode.JwsPayloadNotBase64UrlString);this.protected=n,this.payload=o,this.signature=i}var r=e.prototype;return r.toCompactJws=function(){return e.createCompactJws(this.protected,this.payload,this.signature)},r.verifySignature=function(r){try{return Promise.resolve(e.verifySignature(this.protected,this.payload,this.signature,r))}catch(e){return Promise.reject(e)}},e.verifySignature=function(r,t,n,o){try{return Promise.resolve(e.verifyCompactJws(r+"."+t+"."+n,o))}catch(e){return Promise.reject(e)}},e.verifyCompactJws=function(e,r){try{var n=!1;return Promise.resolve(g((function(){var t="Ed25519"===r.crv?Promise.resolve(a.EdDSA.verify(e,r)).then((function(){})):"secp256k1"===r.crv?Promise.resolve(u.ES256K.verify(e,r)).then((function(){})):(n=!0,!1);return t&&t.then?t.then((function(e){return!n||e})):!n||t}),(function(r){return console.log("Input '"+e+"' failed signature verification: "+t.SidetreeError.createFromError(t.ErrorCode.JwsFailedSignatureValidation,r)),!1})))}catch(e){return Promise.reject(e)}},e.signAsCompactJws=function(e,r,t){try{var n=function(t){return o?t:Promise.resolve(a.EdDSA.sign(e,r,i))},o=!1,i=S({},t,{alg:t&&t.alg?t.alg:"Ed25519"===r.crv?"EdDSA":"ES256K"}),s=function(){if("secp256k1"===r.crv)return o=!0,Promise.resolve(u.ES256K.sign(e,r,i))}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},e.parseCompactJws=function(r){return new e(r)},e.createCompactJws=function(e,r,t){return e+"."+r+"."+t},e}(),U=function(){function e(e,r,n,o){this.operationBuffer=e,this.type=t.OperationType.Deactivate,this.didUniqueSuffix=r,this.signedDataJws=n,this.signedData=o}return e.parseOperationFromAnchorFile=function(r){try{var t=Buffer.from(JSON.stringify(r));return Promise.resolve(e.parseObject(r,t,!0))}catch(e){return Promise.reject(e)}},e.parse=function(r){try{var t=r.toString();return Promise.resolve(j.parse(t)).then((function(t){return Promise.resolve(e.parseObject(t,r,!1))}))}catch(e){return Promise.reject(e)}},e.parseObject=function(r,n,o){try{var i=3;if(o&&(i=2),Object.keys(r).length!==i)throw new t.SidetreeError(t.ErrorCode.DeactivateOperationMissingOrUnknownProperty);if("string"!=typeof r.did_suffix)throw new t.SidetreeError(t.ErrorCode.DeactivateOperationMissingOrInvalidDidUniqueSuffix);var a=A.parseCompactJws(r.signed_data);return Promise.resolve(e.parseSignedDataPayload(a.payload,r.did_suffix)).then((function(i){if(!o&&r.type!==t.OperationType.Deactivate)throw new t.SidetreeError(t.ErrorCode.DeactivateOperationTypeIncorrect);return new e(n,r.did_suffix,a,i)}))}catch(e){return Promise.reject(e)}},e.parseSignedDataPayload=function(e,r){try{var n=t.Encoder.decodeAsString(e);return Promise.resolve(j.parse(n)).then((function(e){if(2!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.DeactivateOperationSignedDataMissingOrUnknownProperty);if(e.did_suffix!==r)throw new t.SidetreeError(t.ErrorCode.DeactivateOperationSignedDidUniqueSuffixMismatch);return _.validatePublicJwk(e.recovery_key),{didSuffix:e.did_suffix,recovery_key:e.recovery_key}}))}catch(e){return Promise.reject(e)}},e}(),K=function(){function e(e,r,n,o,i,a){this.operationBuffer=e,this.type=t.OperationType.Recover,this.didUniqueSuffix=r,this.signedDataJws=n,this.signedData=o,this.encodedDelta=i,this.delta=a}return e.parseOperationFromAnchorFile=function(r){try{var t=Buffer.from(JSON.stringify(r));return Promise.resolve(e.parseObject(r,t,!0))}catch(e){return Promise.reject(e)}},e.parse=function(r){try{var t=r.toString();return Promise.resolve(j.parse(t)).then((function(t){return Promise.resolve(e.parseObject(t,r,!1))}))}catch(e){return Promise.reject(e)}},e.parseObject=function(r,n,o){try{var i=4;if(o&&(i=2),Object.keys(r).length!==i)throw new t.SidetreeError(t.ErrorCode.RecoverOperationMissingOrUnknownProperty);if("string"!=typeof r.did_suffix)throw new t.SidetreeError(t.ErrorCode.RecoverOperationMissingOrInvalidDidUniqueSuffix);var a=A.parseCompactJws(r.signed_data);return Promise.resolve(e.parseSignedDataPayload(a.payload)).then((function(i){function s(t){return new e(n,r.did_suffix,a,i,c,u)}var c=void 0,u=void 0,d=function(){if(!o){if(r.type!==t.OperationType.Recover)throw new t.SidetreeError(t.ErrorCode.RecoverOperationTypeIncorrect);c=r.delta;var e=g((function(){return Promise.resolve(M.parseDelta(r.delta)).then((function(e){u=e}))}),(function(){}));if(e&&e.then)return e.then((function(){}))}}();return d&&d.then?d.then(s):s()}))}catch(e){return Promise.reject(e)}},e.parseSignedDataPayload=function(e){try{var r=t.Encoder.decodeAsString(e);return Promise.resolve(j.parse(r)).then((function(e){if(3!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.RecoverOperationSignedDataMissingOrUnknownProperty);_.validatePublicJwk(e.recovery_key);var r=t.Encoder.decodeAsBuffer(e.delta_hash);t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(r);var n=t.Encoder.decodeAsBuffer(e.recovery_commitment);return t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(n),{delta_hash:e.delta_hash,recovery_key:e.recovery_key,recovery_commitment:e.recovery_commitment}}))}catch(e){return Promise.reject(e)}},e}(),F=function(){function e(e,r,t,n,o){this.model=e,this.didUniqueSuffixes=r,this.createOperations=t,this.recoverOperations=n,this.deactivateOperations=o}return e.parse=function(r){try{var n,o=function(r){var o;if(i)return r;function a(r){function n(r){function n(r){function n(r){if(O.hasDuplicates(d))throw new t.SidetreeError(t.ErrorCode.AnchorFileMultipleOperationsForTheSameDid);return new e(o,d,f,i,a)}var a=[],s=function(){if(void 0!==c.deactivate){if(!Array.isArray(c.deactivate))throw new t.SidetreeError(t.ErrorCode.AnchorFileDeactivatePropertyNotArray);var e=y(c.deactivate,(function(e){return Promise.resolve(U.parseOperationFromAnchorFile(e)).then((function(e){a.push(e),d.push(e.didUniqueSuffix)}))}));if(e&&e.then)return e.then((function(){}))}}();return s&&s.then?s.then(n):n()}var i=[],a=function(){if(void 0!==c.recover){if(!Array.isArray(c.recover))throw new t.SidetreeError(t.ErrorCode.AnchorFileRecoverPropertyNotArray);var e=y(c.recover,(function(e){return Promise.resolve(K.parseOperationFromAnchorFile(e)).then((function(e){i.push(e),d.push(e.didUniqueSuffix)}))}));if(e&&e.then)return e.then((function(){}))}}();return a&&a.then?a.then(n):n()}var i=new Set(["map_file_uri","operations","writer_lock_id"]);for(var a in o)if(!i.has(a))throw new t.SidetreeError(t.ErrorCode.AnchorFileHasUnknownProperty);if(!Object.prototype.hasOwnProperty.call(o,"map_file_uri"))throw new t.SidetreeError(t.ErrorCode.AnchorFileMapFileHashMissing);if(!Object.prototype.hasOwnProperty.call(o,"operations"))throw new t.SidetreeError(t.ErrorCode.AnchorFileMissingOperationsProperty);if(Object.prototype.hasOwnProperty.call(o,"writer_lock_id")&&"string"!=typeof o.writer_lock_id)throw new t.SidetreeError(t.ErrorCode.AnchorFileWriterLockIPropertyNotString);if("string"!=typeof o.map_file_uri)throw new t.SidetreeError(t.ErrorCode.AnchorFileMapFileHashNotString);var s=new Set(["create","recover","deactivate"]),c=o.operations;for(var u in c)if(!s.has(u))throw new t.SidetreeError(t.ErrorCode.AnchorFileUnexpectedPropertyInOperations,"Unexpected property "+u+" in 'operations' property in anchor file.");var d=[],f=[],h=function(){if(void 0!==c.create){if(!Array.isArray(c.create))throw new t.SidetreeError(t.ErrorCode.AnchorFileCreatePropertyNotArray);var e=y(c.create,(function(e){return Promise.resolve(x.parseOperationFromAnchorFile(e)).then((function(e){f.push(e),d.push(e.didUniqueSuffix)}))}));if(e&&e.then)return e.then((function(){}))}}();return h&&h.then?h.then(n):n()}var s=g((function(){return Promise.resolve(j.parse(n)).then((function(e){o=e}))}),(function(e){throw t.SidetreeError.createFromError(t.ErrorCode.AnchorFileNotJson,e)}));return s&&s.then?s.then(a):a()},i=!1,a=g((function(){return Promise.resolve(k.decompress(r)).then((function(e){n=e}))}),(function(e){throw t.SidetreeError.createFromError(t.ErrorCode.AnchorFileDecompressionFailure,e)}));return Promise.resolve(a&&a.then?a.then(o):o(a))}catch(e){return Promise.reject(e)}},e.createModel=function(e,r,t,n,o){try{var i=t.map((function(e){return{suffix_data:e.encodedSuffixData}})),a=n.map((function(e){return{did_suffix:e.didUniqueSuffix,signed_data:e.signedDataJws.toCompactJws()}})),s=o.map((function(e){return{did_suffix:e.didUniqueSuffix,signed_data:e.signedDataJws.toCompactJws()}}));return Promise.resolve({writer_lock_id:e,map_file_uri:r,operations:{create:i,recover:a,deactivate:s}})}catch(e){return Promise.reject(e)}},e.createBuffer=function(r,t,n,o,i){try{return Promise.resolve(e.createModel(r,t,n,o,i)).then((function(e){var r=JSON.stringify(e),t=Buffer.from(r);return k.compress(t)}))}catch(e){return Promise.reject(e)}},e}(),I=function(){function e(e,r,t){this.versionManager=e,this.blockchain=r,this.batchingIntervalInSeconds=t,this.continuePeriodicBatchWriting=!1}var r=e.prototype;return r.startPeriodicBatchWriting=function(){var e=this;this.continuePeriodicBatchWriting=!0,setImmediate((function(){try{return Promise.resolve(e.writeOperationBatch())}catch(e){return Promise.reject(e)}}))},r.stopPeriodicBatchWriting=function(){console.info("Stopped periodic batch writing."),this.continuePeriodicBatchWriting=!1},r.writeOperationBatch=function(){try{var e=this,r=d(),t=w((function(){return g((function(){console.info("Start operation batch writing...");var r=e.versionManager.getBatchWriter(e.blockchain.approximateTime.time);return Promise.resolve(r.write()).then((function(){}))}),(function(e){console.error("Unexpected and unhandled error during batch writing, investigate and fix:"),console.error(e)}))}),(function(t,n){if(console.info("End batch writing. Duration: "+r.rounded()+" ms."),e.continuePeriodicBatchWriting&&(console.info("Waiting for "+e.batchingIntervalInSeconds+" seconds before writing another batch."),setTimeout((function(){try{return Promise.resolve(e.writeOperationBatch())}catch(e){return Promise.reject(e)}}),1e3*e.batchingIntervalInSeconds)),t)throw n;return n}));return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},e}(),J=function(){function e(){}return e.parse=function(e){try{var r=this,n=d();return Promise.resolve(k.decompress(e)).then((function(e){return Promise.resolve(j.parse(e)).then((function(e){console.info("Parsed chunk file in "+n.rounded()+" ms.");var o=new Set(["deltas"]);for(var i in e)if(!o.has(i))throw new t.SidetreeError(t.ErrorCode.ChunkFileUnexpectedProperty,"Unexpected property "+i+" in chunk file.");return r.validateDeltasProperty(e.deltas),e}))}))}catch(e){return Promise.reject(e)}},e.validateDeltasProperty=function(e){if(!(e instanceof Array))throw new t.SidetreeError(t.ErrorCode.ChunkFileDeltasPropertyNotArray,"Invalid chunk file, deltas property is not an array.");for(var r,n=b(e);!(r=n()).done;){var o=r.value;if("string"!=typeof o)throw new t.SidetreeError(t.ErrorCode.ChunkFileDeltasNotArrayOfStrings,"Invalid chunk file, deltas property is not an array of strings.");var i=Buffer.from(o);if(i.length>t.protocolParameters.maxDeltaSizeInBytes)throw new t.SidetreeError(t.ErrorCode.ChunkFileDeltaSizeExceedsLimit,"Operation size of "+i.length+" bytes exceeds the allowed limit of "+t.protocolParameters.maxDeltaSizeInBytes+" bytes.")}},e.createBuffer=function(e,r,t){try{var n=[];n.push.apply(n,e.map((function(e){return e.encodedDelta}))),n.push.apply(n,r.map((function(e){return e.encodedDelta}))),n.push.apply(n,t.map((function(e){return e.encodedDelta})));var o=Buffer.from(JSON.stringify({deltas:n}));return Promise.resolve(k.compress(Buffer.from(o)))}catch(e){return Promise.reject(e)}},e}(),B=function(){function e(e,r){this.maxConcurrentDownloads=e,this.cas=r,this.pendingDownloads=[],this.activeDownloads=new Map,this.completedDownloads=new Map,isNaN(e)&&(console.info("Maximum concurrent CAS download count not given, defaulting to 20."),this.maxConcurrentDownloads=20)}var r=e.prototype;return r.start=function(){var e=this;try{for(var r,t=[],n=b(this.activeDownloads);!(r=n()).done;){var o=r.value,i=o[0],a=o[1];a.completed&&(this.completedDownloads.set(i,a.fetchResult),t.push(i),a.resolve())}for(var s=0,c=t;s<c.length;s++)this.activeDownloads.delete(c[s]);var u=this.maxConcurrentDownloads-this.activeDownloads.size;if(u<=0)return;if(0===this.pendingDownloads.length)return;for(var d=0;d<this.pendingDownloads.length&&d<u;d++){var f=this.pendingDownloads[d];this.downloadAsync(f),this.activeDownloads.set(f.handle,f)}this.pendingDownloads.splice(0,u)}catch(e){console.error("Encountered unhandled/unexpected error in DownloadManager, must investigate and fix: "+e)}finally{setTimeout((function(){try{return Promise.resolve(e.start())}catch(e){return Promise.reject(e)}}),1e3)}},r.download=function(e,r){try{var t=this,n=f.randomBytes(32),o=new Promise((function(o){t.pendingDownloads.push({handle:n,contentHash:e,maxSizeInBytes:r,resolve:o,completed:!1,content:void 0})}));return Promise.resolve(o).then((function(){var e=t.completedDownloads.get(n);return t.completedDownloads.delete(n),e}))}catch(e){return Promise.reject(e)}},r.downloadAsync=function(e){try{var r=this,t="",n=w((function(){return g((function(){return t=e.contentHash,Promise.resolve(r.cas.read(t)).then((function(r){e.fetchResult=r}))}),(function(e){console.error("Unexpected error while downloading '"+t+", investigate and fix "+e+"'.")}))}),(function(r,t){if(e.completed=!0,r)throw t;return t}));return Promise.resolve(n&&n.then?n.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},e}(),q=function(){function e(e,r,n,o,i,a){this.operationBuffer=e,this.type=t.OperationType.Update,this.didUniqueSuffix=r,this.signedDataJws=n,this.signedData=o,this.encodedDelta=i,this.delta=a}return e.parseOperationFromMapFile=function(r){try{var t=Buffer.from(JSON.stringify(r));return Promise.resolve(e.parseObject(r,t,!0))}catch(e){return Promise.reject(e)}},e.parse=function(r){try{var t=r.toString();return Promise.resolve(j.parse(t)).then((function(t){return Promise.resolve(e.parseObject(t,r,!1))}))}catch(e){return Promise.reject(e)}},e.parseObject=function(r,n,o){try{var i=4;if(o&&(i=2),Object.keys(r).length!==i)throw new t.SidetreeError(t.ErrorCode.UpdateOperationMissingOrUnknownProperty);if("string"!=typeof r.did_suffix)throw new t.SidetreeError(t.ErrorCode.UpdateOperationMissingDidUniqueSuffix);var a=A.parseCompactJws(r.signed_data);return Promise.resolve(e.parseSignedDataPayload(a.payload)).then((function(i){function s(t){return new e(n,r.did_suffix,a,i,c,u)}var c=void 0,u=void 0,d=function(){if(!o){if(r.type!==t.OperationType.Update)throw new t.SidetreeError(t.ErrorCode.UpdateOperationTypeIncorrect);return c=r.delta,Promise.resolve(M.parseDelta(c)).then((function(e){u=e}))}}();return d&&d.then?d.then(s):s()}))}catch(e){return Promise.reject(e)}},e.parseSignedDataPayload=function(e){try{var r=t.Encoder.decodeAsString(e);return Promise.resolve(j.parse(r)).then((function(e){if(2!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.UpdateOperationSignedDataHasMissingOrUnknownProperty);_.validatePublicJwk(e.update_key);var r=t.Encoder.decodeAsBuffer(e.delta_hash);return t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(r),{delta_hash:e.delta_hash,update_key:e.update_key}}))}catch(e){return Promise.reject(e)}},e}(),N=function(){function e(e,r,t){this.model=e,this.didUniqueSuffixes=r,this.updateOperations=t}return e.parse=function(r){try{var n,o=function(r){var o;if(i)return r;function a(r){var n=new Set(["chunks","operations"]);for(var i in o)if(!n.has(i))throw new t.SidetreeError(t.ErrorCode.MapFileHasUnknownProperty);return e.validateChunksProperty(o.chunks),Promise.resolve(e.parseOperationsProperty(o.operations)).then((function(r){var t=r.map((function(e){return e.didUniqueSuffix}));return new e(o,t,r)}))}var s=g((function(){return Promise.resolve(j.parse(n)).then((function(e){o=e}))}),(function(e){throw t.SidetreeError.createFromError(t.ErrorCode.MapFileNotJson,e)}));return s&&s.then?s.then(a):a()},i=!1,a=g((function(){return Promise.resolve(k.decompress(r)).then((function(e){n=e}))}),(function(e){throw t.SidetreeError.createFromError(t.ErrorCode.MapFileDecompressionFailure,e)}));return Promise.resolve(a&&a.then?a.then(o):o(a))}catch(e){return Promise.reject(e)}},e.parseOperationsProperty=function(e){try{var r=function(){var e=n.map((function(e){return e.didUniqueSuffix}));if(O.hasDuplicates(e))throw new t.SidetreeError(t.ErrorCode.MapFileMultipleOperationsForTheSameDid);return n};if(void 0===e)return Promise.resolve([]);if(1!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.MapFileOperationsPropertyHasMissingOrUnknownProperty);var n=[];if(!Array.isArray(e.update))throw new t.SidetreeError(t.ErrorCode.MapFileUpdateOperationsNotArray);var o=y(e.update,(function(e){return Promise.resolve(q.parseOperationFromMapFile(e)).then((function(e){n.push(e)}))}));return Promise.resolve(o&&o.then?o.then(r):r())}catch(e){return Promise.reject(e)}},e.validateChunksProperty=function(e){if(!Array.isArray(e))throw new t.SidetreeError(t.ErrorCode.MapFileChunksPropertyMissingOrIncorrectType);if(1!==e.length)throw new t.SidetreeError(t.ErrorCode.MapFileChunksPropertyDoesNotHaveExactlyOneElement);if(1!==Object.keys(e[0]).length)throw new t.SidetreeError(t.ErrorCode.MapFileChunkHasMissingOrUnknownProperty)},e.createBuffer=function(e,r){try{var t=r.map((function(e){return{did_suffix:e.didUniqueSuffix,signed_data:e.signedDataJws.toCompactJws()}})),n={chunks:[{chunk_file_uri:e}]};t.length>0&&(n.operations={update:t});var o=JSON.stringify(n);return Promise.resolve(k.compress(Buffer.from(o)))}catch(e){return Promise.reject(e)}},e}(),R=function(){function e(e){this.versionManager=e}return e.prototype.getQualifiedTransactions=function(e){try{for(var r,t=this,n=void 0,o=[],i=b(e);!(r=i()).done;){var a=r.value;a.transactionTime!==n&&(o.push([]),n=a.transactionTime),o[o.length-1].push(a)}var s=[],c=y(o,(function(e){var r=t.versionManager.getTransactionSelector(e[0].transactionTime);return Promise.resolve(r.selectQualifiedTransactions(e)).then((function(e){s.push.apply(s,e)}))}));return Promise.resolve(c&&c.then?c.then((function(){return s})):s)}catch(e){return Promise.reject(e)}},e}(),H=function(){function e(e,r,t,n,o,i,a){this.versionManager=e,this.blockchain=r,this.maxConcurrentDownloads=t,this.operationStore=n,this.transactionStore=o,this.unresolvableTransactionStore=i,this.observingIntervalInSeconds=a,this.continuePeriodicProcessing=!1,this.transactionsUnderProcessing=[],this.throughputLimiter=new R(e)}var r=e.prototype;return r.refreshLastKnownTransaction=function(){try{var e=this;return Promise.resolve(e.transactionStore.getLastTransaction()).then((function(r){e.lastKnownTransaction=r}))}catch(e){return Promise.reject(e)}},r.startPeriodicProcessing=function(){try{var e=this;return Promise.resolve(e.refreshLastKnownTransaction()).then((function(){console.info("Starting periodic transactions processing."),setImmediate((function(){try{return e.continuePeriodicProcessing=!0,e.processTransactions(),Promise.resolve()}catch(e){return Promise.reject(e)}}))}))}catch(e){return Promise.reject(e)}},r.stopPeriodicProcessing=function(){console.info("Stopped periodic transactions processing."),this.continuePeriodicProcessing=!1},r.processTransactions=function(e){void 0===e&&(e=!1);try{var r=this;return Promise.resolve(w((function(){return g((function(){return Promise.resolve(r.storeConsecutiveTransactionsProcessed()).then((function(){function n(t){return Promise.resolve(r.storeConsecutiveTransactionsProcessed()).then((function(){return console.info("Successfully kicked off downloading/processing of all new Sidetree transactions."),Promise.resolve(r.processUnresolvableTransactions(e)).then((function(){}))}))}var o=!1,i=function(e,r){var t;do{var n=e();if(n&&n.then){if(!l(n)){t=!0;break}n=n.v}var o=r();if(l(o)&&(o=o.v),!o)return n}while(!o.then);const i=new h,a=p.bind(null,i,2);return(t?n.then(s):o.then(c)).then(void 0,a),i;function s(t){for(n=t;l(o=r())&&(o=o.v),o;){if(o.then)return void o.then(c).then(void 0,a);if((n=e())&&n.then){if(!l(n))return void n.then(s).then(void 0,a);n=n.v}}p(i,1,n)}function c(t){if(t){do{if((n=e())&&n.then){if(!l(n))return void n.then(s).then(void 0,a);n=n.v}if(l(t=r())&&(t=t.v),!t)return void p(i,1,n)}while(!t.then);t.then(c).then(void 0,a)}else p(i,1,n)}}((function(){function n(n){var a=i?i.transactions:[];return o=!!i&&i.moreTransactions,Promise.resolve(r.throughputLimiter.getQualifiedTransactions(a)).then((function(n){function i(){function e(){a&&a.length>0&&(r.lastKnownTransaction=a[a.length-1])}var t=!1;u&&(c<=r.blockchain.approximateTime.time?(t=!0,o=!0):console.info("Blockchain microservice blockchain time is behind last known transaction time, waiting for blockchain microservice to catch up..."));var n=t?(console.info("Block reorganization detected."),Promise.resolve(r.waitUntilCountOfTransactionsUnderProcessingIsLessOrEqualTo(0)).then((function(){return console.info("Reverting invalid transactions..."),Promise.resolve(r.revertInvalidTransactions()).then((function(){console.info("Completed reverting invalid transactions.")}))}))):Promise.resolve(r.waitUntilCountOfTransactionsUnderProcessingIsLessOrEqualTo(r.maxConcurrentDownloads)).then((function(){}));return n&&n.then?n.then(e):e()}var s=y(n=n.sort((function(e,r){return e.transactionNumber-r.transactionNumber})),(function(n){var o={transaction:n,processingStatus:t.TransactionProcessingStatus.Pending};r.transactionsUnderProcessing.push(o);var i=function(){if(e)return Promise.resolve(r.processTransaction(n,o)).then((function(){}));r.processTransaction(n,o)}();if(i&&i.then)return i.then((function(){}))}));return s&&s.then?s.then(i):i()}))}var i,a=r.lastKnownTransaction?r.lastKnownTransaction.transactionNumber:void 0,s=r.lastKnownTransaction?r.lastKnownTransaction.transactionTimeHash:void 0,c=r.lastKnownTransaction?r.lastKnownTransaction.transactionTime:0,u=!1,f=d(),h=g((function(){return console.info("Fetching Sidetree transactions from blockchain service..."),Promise.resolve(r.blockchain.read(void 0!==a?a+1:void 0,s)).then((function(e){i=e,console.info("Fetched "+i.transactions.length+" Sidetree transactions from blockchain service in "+f.rounded()+" ms.")}))}),(function(e){if(!(e instanceof t.SidetreeError&&e.code===t.SharedErrorCode.InvalidTransactionNumberOrTimeHash))throw e;console.info("Invalid transaction number "+a+" or time hash "+s+" given to blockchain service."),u=!0}));return h&&h.then?h.then(n):n()}),(function(){return!!o}));return i&&i.then?i.then(n):n()}))}),(function(e){console.error("Encountered unhandled and possibly fatal Observer error, must investigate and fix:"),console.error(e)}))}),(function(e,t){if(r.continuePeriodicProcessing&&(console.info("Waiting for "+r.observingIntervalInSeconds+" seconds before fetching and processing transactions again."),setTimeout((function(){try{return Promise.resolve(r.processTransactions())}catch(e){return Promise.reject(e)}}),1e3*r.observingIntervalInSeconds)),e)throw t;return t})))}catch(e){return Promise.reject(e)}},r.waitUntilCountOfTransactionsUnderProcessingIsLessOrEqualTo=function(e){try{var r=this,t=P((function(){return r.transactionsUnderProcessing.length>e}),void 0,(function(){return Promise.resolve(r.storeConsecutiveTransactionsProcessed()).then((function(){return Promise.resolve(new Promise((function(e){return setTimeout(e,1e3)}))).then((function(){}))}))}));return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},r.processUnresolvableTransactions=function(e){void 0===e&&(e=!1);try{var r=this,n=d();return Promise.resolve(r.unresolvableTransactionStore.getUnresolvableTransactionsDueForRetry()).then((function(o){function i(){var e=P((function(){return a.length>0}),void 0,(function(){for(var e=0;e<a.length&&a[e].processingStatus===t.TransactionProcessingStatus.Processed;)e++;return a.splice(0,e),Promise.resolve(new Promise((function(e){return setTimeout(e,1e3)}))).then((function(){}))}));if(e&&e.then)return e.then((function(){}))}console.info("Fetched "+o.length+" unresolvable transactions to retry in "+n.rounded()+" ms.");var a=[],s=y(o,(function(n){var o={transaction:n,processingStatus:t.TransactionProcessingStatus.Pending};a.push(o);var i=function(){if(e)return Promise.resolve(r.processTransaction(n,o)).then((function(){}));r.processTransaction(n,o)}();if(i&&i.then)return i.then((function(){}))}));return s&&s.then?s.then(i):i()}))}catch(e){return Promise.reject(e)}},r.storeConsecutiveTransactionsProcessed=function(){try{var e=function(){r.transactionsUnderProcessing.splice(0,n)},r=this,n=0,o=P((function(){return n<r.transactionsUnderProcessing.length&&r.transactionsUnderProcessing[n].processingStatus===t.TransactionProcessingStatus.Processed}),void 0,(function(){return Promise.resolve(r.transactionStore.addTransaction(r.transactionsUnderProcessing[n].transaction)).then((function(){n++}))}));return Promise.resolve(o&&o.then?o.then(e):e())}catch(e){return Promise.reject(e)}},r.processTransaction=function(e,r){try{var n,o=this,i=w((function(){return g((function(){var r=o.versionManager.getTransactionProcessor(e.transactionTime);return Promise.resolve(r.processTransaction(e)).then((function(e){n=e}))}),(function(r){console.error("Unhandled error encountered processing transaction '"+e.transactionNumber+"'."),console.error(r),n=!1}))}),(function(i,a){function s(){if(i)throw a;return a}console.info("Finished processing transaction '"+e.transactionNumber+"'."),r.processingStatus=t.TransactionProcessingStatus.Processed;var c=n?(console.info("Removing transaction '"+e.transactionNumber+"' from unresolvable transactions if exists..."),Promise.resolve(o.unresolvableTransactionStore.removeUnresolvableTransaction(e)).then((function(){}))):(console.info("Recording failed processing attempt for transaction '"+e.transactionNumber+"'..."),Promise.resolve(o.unresolvableTransactionStore.recordUnresolvableTransactionFetchAttempt(e)).then((function(){})));return c&&c.then?c.then(s):s()}));return Promise.resolve(i&&i.then?i.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},r.revertInvalidTransactions=function(){try{var e=this;return Promise.resolve(e.transactionStore.getExponentiallySpacedTransactions()).then((function(r){return Promise.resolve(e.blockchain.getFirstValidTransaction(r)).then((function(r){var t=void 0===r?void 0:r.transactionNumber;return console.info("Best known valid recent transaction: "+t),console.info("Reverting operations..."),Promise.resolve(e.operationStore.delete(t)).then((function(){return Promise.resolve(e.transactionStore.removeTransactionsLaterThan(t)).then((function(){return Promise.resolve(e.unresolvableTransactionStore.removeUnresolvableTransactionsLaterThan(t)).then((function(){e.lastKnownTransaction=r}))}))}))}))}))}catch(e){return Promise.reject(e)}},e}(),V=function(){function e(){}return e.parse=function(e){try{var r=e.toString(),n=JSON.parse(r),o=n.type;if(o===t.OperationType.Create)return Promise.resolve(x.parseObject(n,e,!1));if(o===t.OperationType.Update)return Promise.resolve(q.parseObject(n,e,!1));if(o===t.OperationType.Recover)return Promise.resolve(K.parseObject(n,e,!1));if(o===t.OperationType.Deactivate)return Promise.resolve(U.parseObject(n,e,!1));throw new t.SidetreeError(t.ErrorCode.OperationTypeUnknownOrMissing)}catch(e){return Promise.reject(e)}},e}();V.maxEncodedRevealValueLength=50;var L=function(){function e(){}return e.generateRandomHash=function(){var e=f.randomBytes(32);return t.Encoder.encode(t.Multihash.hash(e))},e.generateKeyPair=function(e,r){try{return Promise.resolve(_.generateEd25519KeyPair()).then((function(n){var o=n[1];return[{id:e,type:"Ed25519VerificationKey2018",jwk:n[0],purpose:r||Object.values(t.PublicKeyPurpose)},o]}))}catch(e){return Promise.reject(e)}},e.generateAnchoredCreateOperation=function(r){try{return Promise.resolve(e.generateCreateOperation()).then((function(e){return{createOperation:e.createOperation,operationRequest:e.operationRequest,anchoredOperationModel:{type:t.OperationType.Create,didUniqueSuffix:e.createOperation.didUniqueSuffix,operationBuffer:e.createOperation.operationBuffer,transactionNumber:r.transactionNumber,transactionTime:r.transactionTime,operationIndex:r.operationIndex},recoveryPublicKey:e.recoveryPublicKey,recoveryPrivateKey:e.recoveryPrivateKey,updatePublicKey:e.updatePublicKey,updatePrivateKey:e.updatePrivateKey,signingPublicKey:e.signingPublicKey,signingPrivateKey:e.signingPrivateKey,nextUpdateRevealValueEncodedString:e.nextUpdateRevealValueEncodedString}}))}catch(e){return Promise.reject(e)}},e.generateCreateOperation=function(){try{return Promise.resolve(_.generateEd25519KeyPair()).then((function(r){var n=r[0],o=r[1];return Promise.resolve(_.generateEd25519KeyPair()).then((function(r){var i=r[0],a=r[1];return Promise.resolve(e.generateKeyPair("signingKey")).then((function(r){var s=r[0],c=r[1],u=e.generateServiceEndpoints(["serviceEndpointId123"]);return Promise.resolve(e.generateCreateOperationRequest(n,i,[s],u)).then((function(e){var r=Buffer.from(JSON.stringify(e));return Promise.resolve(x.parse(r)).then((function(r){var u=t.Multihash.canonicalizeThenHashThenEncode(s.jwk);return{createOperation:r,operationRequest:e,recoveryPublicKey:n,recoveryPrivateKey:o,updatePublicKey:i,updatePrivateKey:a,signingPublicKey:s,signingPrivateKey:c,nextUpdateRevealValueEncodedString:u}}))}))}))}))}))}catch(e){return Promise.reject(e)}},e.generateRecoverOperation=function(r){try{return Promise.resolve(_.generateEd25519KeyPair()).then((function(t){var n=t[0],o=t[1];return Promise.resolve(e.generateKeyPair("newSigningKey")).then((function(t){var i=t[0],a=t[1];return Promise.resolve(e.generateKeyPair("newKey")).then((function(t){var s=t[0],c=e.generateServiceEndpoints(["serviceEndpointId123"]);return Promise.resolve(e.generateKeyPair("update_key")).then((function(t){var u=t[0],d=t[1];return Promise.resolve(e.generateRecoverOperationRequest(r.didUniqueSuffix,r.recoveryPrivateKey,n,i,c,[s])).then((function(e){var r=Buffer.from(JSON.stringify(e));return Promise.resolve(K.parse(r)).then((function(e){return{recoverOperation:e,operationBuffer:r,recoveryPublicKey:n,recoveryPrivateKey:o,signingPublicKey:i,signingPrivateKey:a,update_key:u,updatePrivateKey:d}}))}))}))}))}))}))}catch(e){return Promise.reject(e)}},e.generateUpdateOperation=function(r,n,o){try{return Promise.resolve(e.generateKeyPair("additional-key")).then((function(i){var a=i[0],s=i[1];return Promise.resolve(e.createUpdateOperationRequestForAddingAKey(r,n,o,a,t.Multihash.canonicalizeThenHashThenEncode(a))).then((function(e){var r=Buffer.from(JSON.stringify(e));return Promise.resolve(q.parse(r)).then((function(e){return{updateOperation:e,operationBuffer:r,additionalKeyId:"additional-key",additionalPublicKey:a,additionalPrivateKey:s,nextUpdateKey:a.jwk}}))}))}))}catch(e){return Promise.reject(e)}},e.createAnchoredOperationModelFromOperationModel=function(e,r,t,n){return{didUniqueSuffix:e.didUniqueSuffix,type:e.type,operationBuffer:e.operationBuffer,operationIndex:n,transactionNumber:t,transactionTime:r}},e.generateCreateOperationRequest=function(e,r,n,o){try{var i=[{action:"replace",document:{public_keys:n,service_endpoints:o}}],a={update_commitment:t.Multihash.canonicalizeThenHashThenEncode(r),patches:i},s=Buffer.from(JSON.stringify(a)),c={delta_hash:t.Encoder.encode(t.Multihash.hash(s)),recovery_commitment:t.Multihash.canonicalizeThenHashThenEncode(e)},u=t.Encoder.encode(JSON.stringify(c)),d=t.Encoder.encode(s);return Promise.resolve({type:t.OperationType.Create,suffix_data:u,delta:d})}catch(e){return Promise.reject(e)}},e.generateUpdateOperationRequest=function(r){try{return void 0===r&&(r=e.generateRandomHash()),Promise.resolve(e.generateKeyPair("nextUpdateKey")).then((function(n){var o=t.Multihash.canonicalizeThenHashThenEncode(n[0].jwk);return Promise.resolve(e.generateKeyPair("anyNewKey")).then((function(t){var n=[{action:"add-public-keys",public_keys:[t[0]]}];return Promise.resolve(e.generateKeyPair("anySigningKeyId")).then((function(t){return Promise.resolve(e.createUpdateOperationRequest(r,t[0].jwk,t[1],o,n)).then((function(e){var r=Buffer.from(JSON.stringify(e));return Promise.resolve(q.parse(r)).then((function(t){return{request:e,buffer:r,updateOperation:t}}))}))}))}))}))}catch(e){return Promise.reject(e)}},e.createUpdateOperationRequest=function(r,n,o,i,a){try{var s=JSON.stringify({patches:a,update_commitment:i}),c=t.Encoder.encode(t.Multihash.hash(Buffer.from(s))),u=t.Encoder.encode(s);return Promise.resolve(e.signUsingEd25519({update_key:n,delta_hash:c},o)).then((function(e){return{type:t.OperationType.Update,did_suffix:r,delta:u,signed_data:e}}))}catch(e){return Promise.reject(e)}},e.generateRecoverOperationRequest=function(r,n,o,i,a,s){try{var c={public_keys:s,service_endpoints:a};return Promise.resolve(e.createRecoverOperationRequest(r,n,o,t.Multihash.canonicalizeThenHashThenEncode(i.jwk),c))}catch(e){return Promise.reject(e)}},e.createRecoverOperationRequest=function(r,n,o,i,a){try{var s=Buffer.from(JSON.stringify({patches:[{action:"replace",document:a}],update_commitment:i})),c={delta_hash:t.Encoder.encode(t.Multihash.hash(s)),recovery_key:_.getCurve25519PublicKey(n),recovery_commitment:t.Multihash.canonicalizeThenHashThenEncode(o)};return Promise.resolve(e.signUsingEd25519(c,n)).then((function(e){var n=t.Encoder.encode(s);return{type:t.OperationType.Recover,did_suffix:r,signed_data:e,delta:n}}))}catch(e){return Promise.reject(e)}},e.createDeactivateOperationRequest=function(r,n){try{var o={did_suffix:r,recovery_key:_.getCurve25519PublicKey(n)};return Promise.resolve(e.signUsingEd25519(o,n)).then((function(e){return{type:t.OperationType.Deactivate,did_suffix:r,signed_data:e}}))}catch(e){return Promise.reject(e)}},e.generateCreateOperationBuffer=function(r,t,n){try{return Promise.resolve(e.generateCreateOperationRequest(r,t.jwk,[t],n)).then((function(e){return Buffer.from(JSON.stringify(e))}))}catch(e){return Promise.reject(e)}},e.createUpdateOperationRequestForAddingAKey=function(r,t,n,o,i){try{return Promise.resolve(e.createUpdateOperationRequest(r,t,n,i,[{action:"add-public-keys",public_keys:[o]}]))}catch(e){return Promise.reject(e)}},e.createUpdateOperationRequestForHubEndpoints=function(r,t,n,o,i,a){try{var s=[];if(void 0!==i){var c={action:"add-service-endpoints",service_endpoints:e.generateServiceEndpoints([i])};s.push(c)}return a.length>0&&s.push({action:"remove-service-endpoints",ids:a}),Promise.resolve(e.createUpdateOperationRequest(r,t,n,o,s))}catch(e){return Promise.reject(e)}},e.signUsingEd25519=function(e,r){try{return Promise.resolve(A.signAsCompactJws(e,r,{alg:"EdDSA"}))}catch(e){return Promise.reject(e)}},e.createDeactivateOperation=function(r,t){try{return Promise.resolve(e.createDeactivateOperationRequest(r,t)).then((function(e){var r=Buffer.from(JSON.stringify(e));return Promise.resolve(U.parse(r)).then((function(t){return{operationRequest:e,operationBuffer:r,deactivateOperation:t}}))}))}catch(e){return Promise.reject(e)}},e.generateServiceEndpoints=function(e){for(var r,t=[],n=b(e);!(r=n()).done;)t.push({id:r.value,type:"someType",endpoint:"https://www.url.com"});return t},e}(),W=function(){function e(e,r){this.versionManager=e,this.operationStore=r}var r=e.prototype;return r.resolve=function(r){try{var t=this;return console.info("Resolving DID unique suffix '"+r+"'..."),Promise.resolve(t.operationStore.get(r)).then((function(r){var n=e.categorizeOperationsByType(r);return Promise.resolve(t.applyCreateOperation(n.createOperations)).then((function(e){if(void 0!==e){var r=n.recoverOperations.concat(n.deactivateOperations);return Promise.resolve(t.constructCommitValueToOperationLookupMap(r)).then((function(r){return Promise.resolve(t.applyRecoverAndDeactivateOperations(e,r)).then((function(r){return void 0===(e=r).nextRecoveryCommitmentHash?e:Promise.resolve(t.constructCommitValueToOperationLookupMap(n.updateOperations)).then((function(r){return Promise.resolve(t.applyUpdateOperations(e,r)).then((function(r){return e=r}))}))}))}))}}))}))}catch(e){return Promise.reject(e)}},e.categorizeOperationsByType=function(e){for(var r,n=[],o=[],i=[],a=[],s=b(e);!(r=s()).done;){var c=r.value;c.type===t.OperationType.Create?n.push(c):c.type===t.OperationType.Recover?o.push(c):c.type===t.OperationType.Update?i.push(c):a.push(c)}return{createOperations:n,recoverOperations:o,updateOperations:i,deactivateOperations:a}},r.applyCreateOperation=function(e){try{var r,t=!1,n=this,o=y(e,(function(e){return Promise.resolve(n.applyOperation(e,void 0)).then((function(e){void 0!==(r=e)&&(t=!0)}))}),(function(){return t}));return Promise.resolve(o&&o.then?o.then((function(){return r})):r)}catch(e){return Promise.reject(e)}},r.applyRecoverAndDeactivateOperations=function(e,r){try{var t=!1,n=!1,o=this,i=e,a=P((function(){return!(n||t||!r.has(i.nextRecoveryCommitmentHash))}),void 0,(function(){var e=r.get(i.nextRecoveryCommitmentHash);return e=e.sort((function(e,r){return e.transactionNumber-r.transactionNumber})),Promise.resolve(o.applyFirstValidOperation(e,i)).then((function(e){if(void 0!==e)return void 0===(i=e).nextRecoveryCommitmentHash?(t=!0,i):void 0;n=!0}))}));return Promise.resolve(a&&a.then?a.then((function(e){return t?e:i})):t?a:i)}catch(e){return Promise.reject(e)}},r.applyUpdateOperations=function(e,r){try{var t=!1,n=this,o=e,i=P((function(){return!t&&!!r.has(o.nextUpdateCommitmentHash)}),void 0,(function(){var e=r.get(o.nextUpdateCommitmentHash);return e=e.sort((function(e,r){return e.transactionNumber-r.transactionNumber})),Promise.resolve(n.applyFirstValidOperation(e,o)).then((function(e){void 0!==e?o=e:t=!0}))}));return Promise.resolve(i&&i.then?i.then((function(){return o})):o)}catch(e){return Promise.reject(e)}},r.applyOperation=function(e,r){try{var n=this,o=r,i=g((function(){var r=n.versionManager.getOperationProcessor(e.transactionTime);return Promise.resolve(r.apply(e,o)).then((function(e){o=e}))}),(function(r){console.log("Skipped bad operation for DID "+e.didUniqueSuffix+" at time "+e.transactionTime+". Error: "+t.SidetreeError.stringify(r))}));return Promise.resolve(i&&i.then?i.then((function(){return o})):o)}catch(e){return Promise.reject(e)}},r.applyFirstValidOperation=function(e,r){try{var t=!1,n=this,o=r,i=y(e,(function(e){return Promise.resolve(n.applyOperation(e,o)).then((function(e){if((o=e).lastOperationTransactionNumber!==r.lastOperationTransactionNumber)return t=!0,o}))}),(function(){return t}));return Promise.resolve(i&&i.then?i.then((function(e){return t?e:void 0})):t?i:void 0)}catch(e){return Promise.reject(e)}},r.constructCommitValueToOperationLookupMap=function(e){try{var r=this,n=new Map,o=y(r.versionManager.allSupportedHashAlgorithms,(function(o){var i=y(e,(function(e){var i=r.versionManager.getOperationProcessor(e.transactionTime);return Promise.resolve(i.getRevealValue(e)).then((function(r){var i=t.Multihash.hashThenEncode(r,o);n.has(i)?n.get(i).push(e):n.set(i,[e])}))}));if(i&&i.then)return i.then((function(){}))}));return Promise.resolve(o&&o.then?o.then((function(){return n})):n)}catch(e){return Promise.reject(e)}},e}(),z=function(){function e(e){this.serviceName=e}return e.prototype.getServiceVersion=function(){return{name:this.serviceName,version:e.packageJson.version}},e}();z.packageJson=require("../package.json");var Q=function(){function e(e,r){this.config=e,this.allSupportedHashAlgorithms=[],this.protocolVersionsReverseSorted=r.sort((function(e,r){return r.startingBlockchainTime-e.startingBlockchainTime})),this.batchWriters=new Map,this.operationProcessors=new Map,this.operationQueues=new Map,this.requestHandlers=new Map,this.transactionProcessors=new Map,this.transactionSelectors=new Map,this.versionMetadatas=new Map}var n=e.prototype;return n.initialize=function(e,r,n,o,i,a){try{var s=function(e){if(c)return e;var r=Array.from(u.versionMetadatas.values(),(function(e){return e.hashAlgorithmInMultihashCode}));u.allSupportedHashAlgorithms=Array.from(new Set(r))},c=!1,u=this,d=y(u.protocolVersionsReverseSorted,(function(s){var c=s.version;return Promise.resolve(u.loadDefaultExportsForVersion(c,"MongoDbOperationQueue")).then((function(s){var d=new s(u.config.mongoDbConnectionString,u.config.databaseName);return Promise.resolve(d.initialize()).then((function(){return u.operationQueues.set(c,d),Promise.resolve(u.loadDefaultExportsForVersion(c,"TransactionProcessor")).then((function(s){var f=new s(n,o,e,u);return u.transactionProcessors.set(c,f),Promise.resolve(u.loadDefaultExportsForVersion(c,"TransactionSelector")).then((function(n){var o=new n(a);return u.transactionSelectors.set(c,o),Promise.resolve(u.loadDefaultExportsForVersion(c,"BatchWriter")).then((function(n){var o=new n(d,e,r,u);return u.batchWriters.set(c,o),Promise.resolve(u.loadDefaultExportsForVersion(c,"OperationProcessor")).then((function(e){var r=new e;return u.operationProcessors.set(c,r),Promise.resolve(u.loadDefaultExportsForVersion(c,"RequestHandler")).then((function(e){var r=new e(i,d,u.config.didMethodName);return u.requestHandlers.set(c,r),Promise.resolve(u.loadDefaultExportsForVersion(c,"VersionMetadata")).then((function(e){var r=new e;if(!(r instanceof t.AbstractVersionMetadata))throw new t.SidetreeError(t.CoreErrorCode.VersionManagerVersionMetadataIncorrectType,"make sure VersionMetaData is properly implemented for version "+c);u.versionMetadatas.set(c,r)}))}))}))}))}))}))}))}))}),(function(){return c}));return Promise.resolve(d&&d.then?d.then(s):s(d))}catch(e){return Promise.reject(e)}},n.getBatchWriter=function(e){var r=this.getVersionString(e),n=this.batchWriters.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerBatchWriterNotFound,"Batch writer for blockchain time "+e+" not found.");return n},n.getOperationProcessor=function(e){var r=this.getVersionString(e),n=this.operationProcessors.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerOperationProcessorNotFound,"Operation processor for blockchain time "+e+" not found.");return n},n.getRequestHandler=function(e){var r=this.getVersionString(e),n=this.requestHandlers.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerRequestHandlerNotFound,"Request handler for blockchain time "+e+" not found.");return n},n.getTransactionProcessor=function(e){var r=this.getVersionString(e),n=this.transactionProcessors.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerTransactionProcessorNotFound,"Transaction processor for blockchain time "+e+" not found.");return n},n.getTransactionSelector=function(e){var r=this.getVersionString(e),n=this.transactionSelectors.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerTransactionSelectorNotFound,"Transaction selector for blockchain time "+e+" not found.");return n},n.getVersionMetadata=function(e){var r=this.getVersionString(e);return this.versionMetadatas.get(r)},n.getOperationQueue=function(e){var r=this.getVersionString(e);return this.operationQueues.get(r)},n.getVersionString=function(e){for(var r,n=b(this.protocolVersionsReverseSorted);!(r=n()).done;){var o=r.value;if(e>=o.startingBlockchainTime)return o.version}throw new t.SidetreeError(t.CoreErrorCode.VersionManagerVersionStringNotFound,"Unable to find version string for blockchain time "+e+".")},n.loadDefaultExportsForVersion=function(e,t){try{var n=function(n){return o?n:Promise.resolve(new Promise((function(n){n(r(require("./versions/"+e+"/"+t)))}))).then((function(e){return e.default}))},o=!1,i=function(){if("latest"===e)switch(t){case"MongoDbOperationQueue":return o=!0,Promise.resolve(new Promise((function(e){e(r(require("@sidetree/db")))}))).then((function(e){return e.MongoDbOperationQueue}));case"TransactionProcessor":return o=!0,Promise.resolve(new Promise((function(e){e(require("./TransactionProcessor-f7bea506.js"))}))).then((function(e){return e.default}));case"TransactionSelector":return o=!0,Promise.resolve(new Promise((function(e){e(require("./TransactionSelector-46916bb6.js"))}))).then((function(e){return e.default}));case"BatchWriter":return o=!0,Promise.resolve(new Promise((function(e){e(require("./BatchWriter-51e372ca.js"))}))).then((function(e){return e.default}));case"OperationProcessor":return o=!0,Promise.resolve(new Promise((function(e){e(require("./OperationProcessor-cefade7e.js"))}))).then((function(e){return e.default}));case"RequestHandler":return o=!0,Promise.resolve(new Promise((function(e){e(require("./RequestHandler-5cc027b8.js"))}))).then((function(e){return e.default}));case"VersionMetadata":return o=!0,Promise.resolve(new Promise((function(e){e(require("./VersionMetadata-60bac6fb.js"))}))).then((function(e){return e.default}));default:return void(o=!0)}}();return Promise.resolve(i&&i.then?i.then(n):n(i))}catch(e){return Promise.reject(e)}},e}();exports.AnchorFile=F,exports.ArrayMethods=O,exports.BatchScheduler=I,exports.ChunkFile=J,exports.CreateOperation=x,exports.DeactivateOperation=U,exports.DocumentComposer=D,exports.DownloadManager=B,exports.JsonAsync=j,exports.Jwk=_,exports.Jws=A,exports.MapFile=N,exports.Observer=H,exports.Operation=V,exports.OperationGenerator=L,exports.RecoverOperation=K,exports.Resolver=W,exports.ServiceInfoProvider=z,exports.UpdateOperation=q,exports.VersionManager=Q,exports._catch=g,exports._createForOfIteratorHelperLoose=b,exports._for=P,exports._forTo=v,exports._inheritsLoose=function(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,e.__proto__=r},exports._switch=function(e,r){var t,n=-1;e:{for(var o=0;o<r.length;o++){var i=r[o][0];if(i){var a=i();if(a&&a.then)break e;if(a===e){n=o;break}}else n=o}if(-1!==n){do{for(var s=r[n][1];!s;)n++,s=r[n][1];var c=s();if(c&&c.then){t=!0;break e}var u=r[n][2];n++}while(u&&!u());return c}}const d=new h,f=p.bind(null,d,2);return(t?c.then(l):a.then((function t(a){for(;;){if(a===e){n=o;break}if(++o===r.length){if(-1!==n)break;return void p(d,1,c)}if(i=r[o][0]){if((a=i())&&a.then)return void a.then(t).then(void 0,f)}else n=o}do{for(var s=r[n][1];!s;)n++,s=r[n][1];var c=s();if(c&&c.then)return void c.then(l).then(void 0,f);var u=r[n][2];n++}while(u&&!u());p(d,1,c)}))).then(void 0,f),d;function l(e){for(;;){var t=r[n][2];if(!t||t())break;n++;for(var o=r[n][1];!o;)n++,o=r[n][1];if((e=o())&&e.then)return void e.then(l).then(void 0,f)}p(d,1,e)}};
//# sourceMappingURL=index-0a641848.js.map
