"use strict";var e=require("./index-0a641848.js"),t=require("@sidetree/common");require("fast-json-patch"),require("jose"),require("bip39"),require("@transmute/did-key-ed25519"),require("hdkey"),require("@trust/keyto"),require("@transmute/did-key-secp256k1"),require("time-span"),require("crypto"),exports.default=function(){function r(){}var n=r.prototype;return n.apply=function(e,r){try{var n=function(t){if(a)return t;try{void 0!==o&&o.lastOperationTransactionNumber!==s||console.debug("Ignored invalid operation for DID '"+e.didUniqueSuffix+"' in transaction '"+e.transactionNumber+"' at time '"+e.transactionTime+"' at operation index "+e.operationIndex+".")}catch(e){console.log("Failed logging "+e+".")}return o},a=!1,i=this;if(void 0===r&&e.type!==t.OperationType.Create)return Promise.resolve(void 0);var o,s=r?r.lastOperationTransactionNumber:void 0,u=e.type===t.OperationType.Create?Promise.resolve(i.applyCreateOperation(e,r)).then((function(e){o=e})):e.type===t.OperationType.Update?Promise.resolve(i.applyUpdateOperation(e,r)).then((function(e){o=e})):e.type===t.OperationType.Recover?Promise.resolve(i.applyRecoverOperation(e,r)).then((function(e){o=e})):function(){if(e.type===t.OperationType.Deactivate)return Promise.resolve(i.applyDeactivateOperation(e,r)).then((function(e){o=e}));throw new t.SidetreeError(t.ErrorCode.OperationProcessorUnknownOperationType)}();return Promise.resolve(u&&u.then?u.then(n):n(u))}catch(e){return Promise.reject(e)}},n.getRevealValue=function(r){try{if(r.type===t.OperationType.Create)throw new t.SidetreeError(t.ErrorCode.OperationProcessorCreateOperationDoesNotHaveRevealValue);return Promise.resolve(e.Operation.parse(r.operationBuffer)).then((function(e){switch(e.type){case t.OperationType.Recover:return t.JsonCanonicalizer.canonicalizeAsBuffer(e.signedData.recovery_key);case t.OperationType.Update:return t.JsonCanonicalizer.canonicalizeAsBuffer(e.signedData.update_key);default:return t.JsonCanonicalizer.canonicalizeAsBuffer(e.signedData.recovery_key)}}))}catch(e){return Promise.reject(e)}},n.applyCreateOperation=function(r,n){try{return void 0!==n?Promise.resolve(n):Promise.resolve(e.CreateOperation.parse(r.operationBuffer)).then((function(a){if(!t.Multihash.isValidHash(a.encodedDelta,a.suffixData.delta_hash))return n;var i=a.delta,o={};try{void 0!==i&&(o=e.DocumentComposer.applyPatches(o,i.patches))}catch(e){return console.debug("Unable to apply document patch in transaction number "+r.transactionNumber+" for DID "+r.didUniqueSuffix+": "+t.SidetreeError.stringify(e)+"."),n}return{didUniqueSuffix:a.didUniqueSuffix,document:o,nextRecoveryCommitmentHash:a.suffixData.recovery_commitment,nextUpdateCommitmentHash:i?i.update_commitment:void 0,lastOperationTransactionNumber:r.transactionNumber}}))}catch(e){return Promise.reject(e)}},n.applyUpdateOperation=function(r,n){try{return Promise.resolve(e.UpdateOperation.parse(r.operationBuffer)).then((function(a){return t.Multihash.canonicalizeAndVerify(a.signedData.update_key,n.nextUpdateCommitmentHash)?Promise.resolve(a.signedDataJws.verifySignature(a.signedData.update_key)).then((function(i){var o,s=!1;function u(e){return s?e:{nextRecoveryCommitmentHash:n.nextRecoveryCommitmentHash,document:o,nextUpdateCommitmentHash:a.delta.update_commitment,lastOperationTransactionNumber:r.transactionNumber}}if(!i)return n;if(!t.Multihash.isValidHash(a.encodedDelta,a.signedData.delta_hash))return n;var c=e._catch((function(){return Promise.resolve(e.DocumentComposer.applyUpdateOperation(a,n.document)).then((function(e){o=e}))}),(function(e){return console.debug("Unable to apply document patch in transaction number "+r.transactionNumber+" for DID "+r.didUniqueSuffix+": "+t.SidetreeError.stringify(e)+"."),s=!0,n}));return c&&c.then?c.then(u):u(c)})):n}))}catch(e){return Promise.reject(e)}},n.applyRecoverOperation=function(r,n){try{return Promise.resolve(e.RecoverOperation.parse(r.operationBuffer)).then((function(a){return t.Multihash.canonicalizeAndVerify(a.signedData.recovery_key,n.nextRecoveryCommitmentHash)?Promise.resolve(a.signedDataJws.verifySignature(a.signedData.recovery_key)).then((function(i){if(!i)return n;if(!t.Multihash.isValidHash(a.encodedDelta,a.signedData.delta_hash))return n;var o=a.delta,s={};try{void 0!==o&&(s=e.DocumentComposer.applyPatches(s,o.patches))}catch(e){return console.debug("Unable to apply document patch in transaction number "+r.transactionNumber+" for DID "+r.didUniqueSuffix+": "+t.SidetreeError.stringify(e)+"."),n}return{didUniqueSuffix:a.didUniqueSuffix,document:s,recovery_key:a.signedData.recovery_key,nextRecoveryCommitmentHash:a.signedData.recovery_commitment,nextUpdateCommitmentHash:o?o.update_commitment:void 0,lastOperationTransactionNumber:r.transactionNumber}})):n}))}catch(e){return Promise.reject(e)}},n.applyDeactivateOperation=function(r,n){try{return Promise.resolve(e.DeactivateOperation.parse(r.operationBuffer)).then((function(e){return t.Multihash.canonicalizeAndVerify(e.signedData.recovery_key,n.nextRecoveryCommitmentHash)?Promise.resolve(e.signedDataJws.verifySignature(e.signedData.recovery_key)).then((function(e){return e?{document:n.document,recovery_key:void 0,nextRecoveryCommitmentHash:void 0,nextUpdateCommitmentHash:void 0,lastOperationTransactionNumber:r.transactionNumber}:n})):n}))}catch(e){return Promise.reject(e)}},r}();
//# sourceMappingURL=OperationProcessor-cefade7e.js.map
