"use strict";var r=require("./index-0a641848.js"),e=require("@sidetree/common");require("fast-json-patch"),require("jose"),require("bip39"),require("@transmute/did-key-ed25519"),require("hdkey"),require("@trust/keyto"),require("@transmute/did-key-secp256k1"),require("time-span"),require("crypto");var t,n=(t=require("priorityqueue"))&&"object"==typeof t&&"default"in t?t.default:t;exports.default=function(){function t(r){this.transactionStore=r,this.maxNumberOfOperationsPerBlock=e.protocolParameters.maxNumberOfOperationsPerTransactionTime,this.maxNumberOfTransactionsPerBlock=e.protocolParameters.maxNumberOfTransactionsPerTransactionTime}t.getTransactionPriorityQueue=function(){return new n({comparator:function(r,e){return r.transactionFeePaid-e.transactionFeePaid||e.transactionNumber-r.transactionNumber}})};var a=t.prototype;return a.selectQualifiedTransactions=function(r){try{var e=this;if(!r.length)return Promise.resolve([]);var n=t.getTransactionPriorityQueue(),a=r[0].transactionTime;return t.validateTransactions(r,a),t.enqueueFirstTransactionFromEachWriter(r,a,n),Promise.resolve(e.getNumberOfOperationsAndTransactionsAlreadyInTransactionTime(a)).then((function(r){return t.getHighestFeeTransactionsFromCurrentTransactionTime(e.maxNumberOfOperationsPerBlock-r[0],e.maxNumberOfTransactionsPerBlock-r[1],n)}))}catch(r){return Promise.reject(r)}},t.validateTransactions=function(t,n){for(var a,i=r._createForOfIteratorHelperLoose(t);!(a=i()).done;)if(a.value.transactionTime!==n)throw new e.SidetreeError(e.ErrorCode.TransactionsNotInSameBlock,"transaction must be in the same block to perform rate limiting, investigate and fix")},t.enqueueFirstTransactionFromEachWriter=function(e,t,n){for(var a,i=new Map,o=r._createForOfIteratorHelperLoose(e);!(a=o()).done;){var s=a.value;if(i.has(s.writer)){var c=i.get(s.writer);console.info("Multiple transactions found in transaction time "+t+" from writer "+s.writer+", considering transaction "+c+" and ignoring "+s.transactionNumber)}else n.push(s),i.set(s.writer,s.transactionNumber)}},a.getNumberOfOperationsAndTransactionsAlreadyInTransactionTime=function(t){try{return Promise.resolve(this.transactionStore.getTransactionsStartingFrom(t,t)).then((function(t){var n=0;if(t)for(var a,i=r._createForOfIteratorHelperLoose(t);!(a=i()).done;){var o=a.value;try{n+=e.AnchoredDataSerializer.deserialize(o.anchorString).numberOfOperations}catch(r){console.debug("Error thrown in TransactionSelector: "+JSON.stringify(r,Object.getOwnPropertyNames(r))),console.info("Transaction with anchor string "+o.anchorString+" not considered as selected.")}}return[n,t?t.length:0]}))}catch(r){return Promise.reject(r)}},t.getHighestFeeTransactionsFromCurrentTransactionTime=function(r,t,n){for(var a=0,i=[];i.length<t&&a<r&&n.length>0;){var o=n.pop();try{(a+=e.AnchoredDataSerializer.deserialize(o.anchorString).numberOfOperations)<=r&&i.push(o)}catch(r){console.debug("Error thrown in TransactionSelector: "+JSON.stringify(r,Object.getOwnPropertyNames(r))),console.info("Transaction with anchor string "+o.anchorString+" not selected")}}return i},t}();
//# sourceMappingURL=TransactionSelector-46916bb6.js.map
