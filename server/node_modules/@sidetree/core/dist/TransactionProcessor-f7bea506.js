"use strict";var e=require("./index-0a641848.js"),r=require("@sidetree/common");require("fast-json-patch"),require("jose"),require("bip39"),require("@transmute/did-key-ed25519"),require("hdkey"),require("@trust/keyto"),require("@transmute/did-key-secp256k1"),require("time-span"),require("crypto");var o=require("./ValueTimeLockVerifier-849c26c7.js");exports.default=function(){function t(e,r,o,t){this.downloadManager=e,this.operationStore=r,this.blockchain=o,this.versionMetadataFetcher=t}var n=t.prototype;return n.processTransaction=function(t){try{var n=this;return Promise.resolve(e._catch((function(){var e=r.AnchoredDataSerializer.deserialize(t.anchorString);return o.FeeManager.verifyTransactionFeeAndThrowOnError(t.transactionFeePaid,e.numberOfOperations,t.normalizedTransactionFee),Promise.resolve(n.downloadAndVerifyAnchorFile(t,e.anchorFileHash,e.numberOfOperations)).then((function(r){return Promise.resolve(n.downloadAndVerifyMapFile(r,e.numberOfOperations)).then((function(e){return Promise.resolve(n.downloadAndVerifyChunkFile(e)).then((function(o){return Promise.resolve(n.composeAnchoredOperationModels(t,r,e,o)).then((function(e){return Promise.resolve(n.operationStore.put(e)).then((function(){return!0}))}))}))}))}))}),(function(e){return e instanceof r.SidetreeError?e.code!==r.ErrorCode.CasNotReachable&&e.code!==r.ErrorCode.CasFileNotFound&&(console.info("Ignoring error: "+e.message),!0):(console.error("Unexpected error processing transaction, MUST investigate and fix: "+e.message),!1)})))}catch(e){return Promise.reject(e)}},n.downloadAndVerifyAnchorFile=function(t,n,i){try{var a=this;if(i>r.protocolParameters.maxOperationsPerBatch)throw new r.SidetreeError(r.ErrorCode.TransactionProcessorPaidOperationCountExceedsLimit,"Paid batch size of "+i+" operations exceeds the allowed limit of "+r.protocolParameters.maxOperationsPerBatch+".");return console.info("Downloading anchor file '"+n+"', max file size limit "+r.protocolParameters.maxAnchorFileSizeInBytes+" bytes..."),Promise.resolve(a.downloadFileFromCas(n,r.protocolParameters.maxAnchorFileSizeInBytes)).then((function(n){return Promise.resolve(e.AnchorFile.parse(n)).then((function(e){function n(r){return o.ValueTimeLockVerifier.verifyLockAmountAndThrowOnError(r,i,t.transactionTime,t.writer,a.versionMetadataFetcher),e}var s=e.didUniqueSuffixes.length;if(s>i)throw new r.SidetreeError(r.ErrorCode.AnchorFileOperationCountExceededPaidLimit,"Operation count "+s+" in anchor file exceeded limit of : "+i);return e.model.writer_lock_id?Promise.resolve(a.blockchain.getValueTimeLock(e.model.writer_lock_id)).then(n):n(void 0)}))}))}catch(e){return Promise.reject(e)}},n.downloadAndVerifyMapFile=function(o,t){try{var n=this;return Promise.resolve(e._catch((function(){var i=o.model;return console.info("Downloading map file '"+i.map_file_uri+"', max file size limit "+r.protocolParameters.maxMapFileSizeInBytes+"..."),Promise.resolve(n.downloadFileFromCas(i.map_file_uri,r.protocolParameters.maxMapFileSizeInBytes)).then((function(r){return Promise.resolve(e.MapFile.parse(r)).then((function(r){return(r.updateOperations?r.updateOperations.length:0)>t-o.didUniqueSuffixes.length?void 0:e.ArrayMethods.areMutuallyExclusive(o.didUniqueSuffixes,r.didUniqueSuffixes)?r:void 0}))}))}),(function(e){if(e instanceof r.SidetreeError){if(e.code===r.ErrorCode.CasNotReachable||e.code===r.ErrorCode.CasFileNotFound)throw e}else console.error("Unexpected error fetching map file "+o.model.map_file_uri+", MUST investigate and fix: "+r.SidetreeError.stringify(e))})))}catch(e){return Promise.reject(e)}},n.downloadAndVerifyChunkFile=function(o){try{var t,n=this;return Promise.resolve(void 0===o?void 0:e._catch((function(){return t=o.model.chunks[0].chunk_file_uri,console.info("Downloading chunk file '"+t+"', max size limit "+r.protocolParameters.maxChunkFileSizeInBytes+"..."),Promise.resolve(n.downloadFileFromCas(t,r.protocolParameters.maxChunkFileSizeInBytes)).then((function(r){return Promise.resolve(e.ChunkFile.parse(r))}))}),(function(e){if(e instanceof r.SidetreeError){if(e.code===r.ErrorCode.CasNotReachable||e.code===r.ErrorCode.CasFileNotFound)throw e}else console.error("Unexpected error fetching chunk file "+t+", MUST investigate and fix: "+r.SidetreeError.stringify(e))})))}catch(e){return Promise.reject(e)}},n.composeAnchoredOperationModels=function(r,o,t,n){try{var i=function(){function o(){for(var e=[],o=0;o<d.length;o++){var t=d[o];e.push({didUniqueSuffix:t.didUniqueSuffix,type:t.type,operationBuffer:u[o],operationIndex:o,transactionNumber:r.transactionNumber,transactionTime:r.transactionTime})}return e}var t=e._forTo(c,(function(r){var o=c[r],t=o.operationBuffer.toString();return Promise.resolve(e.JsonAsync.parse(t)).then((function(e){e.type=o.type;var r=Buffer.from(JSON.stringify(e));u.push(r)}))}));return t&&t.then?t.then(o):o()},a=o.createOperations,s=o.recoverOperations,c=o.deactivateOperations,l=t&&t.updateOperations?t.updateOperations:[],d=[];d.push.apply(d,a),d.push.apply(d,s),d.push.apply(d,l),d.push.apply(d,c);var u=[],f=function(){if(void 0!==n){var r=a.length+s.length+l.length,o=0,t=e._for((function(){return o<r&&o<n.deltas.length}),(function(){return o++}),(function(){var r=d[o],t=r.operationBuffer.toString();return Promise.resolve(e.JsonAsync.parse(t)).then((function(e){e.type=r.type,e.delta=n.deltas[o];var t=Buffer.from(JSON.stringify(e));u.push(t)}))}));if(t&&t.then)return t.then((function(){}))}}();return Promise.resolve(f&&f.then?f.then(i):i())}catch(e){return Promise.reject(e)}},n.downloadFileFromCas=function(e,o){try{return console.info("Downloading file '"+e+"', max size limit "+o+"..."),Promise.resolve(this.downloadManager.download(e,o)).then((function(t){if(t.code===r.FetchResultCode.InvalidHash)throw new r.SidetreeError(r.ErrorCode.CasFileHashNotValid,"File hash '"+e+"' is not a valid hash.");if(t.code===r.FetchResultCode.MaxSizeExceeded)throw new r.SidetreeError(r.ErrorCode.CasFileTooLarge,"File '"+e+"' exceeded max size limit of "+o+" bytes.");if(t.code===r.FetchResultCode.NotAFile)throw new r.SidetreeError(r.ErrorCode.CasFileNotAFile,"File hash '"+e+"' points to a content that is not a file.");if(t.code===r.FetchResultCode.CasNotReachable)throw new r.SidetreeError(r.ErrorCode.CasNotReachable,"CAS not reachable for file '"+e+"'.");if(t.code===r.FetchResultCode.NotFound)throw new r.SidetreeError(r.ErrorCode.CasFileNotFound,"File '"+e+"' not found.");return console.info("File '"+e+"' of size "+t.content.length+" downloaded."),t.content}))}catch(e){return Promise.reject(e)}},t}();
//# sourceMappingURL=TransactionProcessor-f7bea506.js.map
