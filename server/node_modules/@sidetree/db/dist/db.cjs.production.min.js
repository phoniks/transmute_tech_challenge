"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("mongodb"),t=require("@sidetree/common"),r=require("typeorm"),n=require("tslib");const o=function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{i(n,1,e(this.v))}catch(e){i(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?i(n,1,t?t(o):o):r?i(n,1,r(o)):i(n,2,o)}catch(e){i(n,2,e)}},n},e}();function i(e,t,r){if(!e.s){if(r instanceof o){if(!r.s)return void(r.o=i.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(i.bind(null,e,t),i.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}function c(e){return e instanceof o&&1&e.s}const a="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function s(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var u=function(){function t(){}return t.isServerAvailable=function(t){try{var r=!1,n=s((function(){return Promise.resolve(e.MongoClient.connect(t,{useUnifiedTopology:!0,useNewUrlParser:!0})).then((function(e){return Promise.resolve(e.close()).then((function(){}))}))}),(function(e){return console.log("Mongoclient connect error: "+e),r=!0,!1}));return Promise.resolve(n&&n.then?n.then((function(e){return!r||e})):!r||n)}catch(e){return Promise.reject(e)}},t.resetDatabase=function(t,r){try{return Promise.resolve(s((function(){return Promise.resolve(e.MongoClient.connect(t,{useUnifiedTopology:!0,useNewUrlParser:!0})).then((function(e){return Promise.resolve(e.db(r)).then((function(t){return Promise.resolve(t.dropDatabase()).then((function(t){return Promise.resolve(e.close()).then((function(){return t}))}))}))}))}),(function(e){return console.log("Mongoclient connect error: "+e),!1})))}catch(e){return Promise.reject(e)}},t.createCollectionIfNotExist=function(e,t){try{return Promise.resolve(e.collections()).then((function(r){var n,o=r.map((function(e){return e.collectionName})).find((function(e){return e===t})),i=function(){if(!o)return console.info("Creating new collection "+t),Promise.resolve(e.createCollection(t)).then((function(e){n=e}));console.info("Reusing existing collection "+t),n=e.collection(t)}();return i&&i.then?i.then((function(){return n})):n}))}catch(e){return Promise.reject(e)}},t}();function l(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var f=function(){function t(e,t){this.serverUrl=e,this.databaseName=t}var r=t.prototype;return r.close=function(){try{return Promise.resolve(this.client.close())}catch(e){return Promise.reject(e)}},r.clearCollection=function(){try{return Promise.resolve(this.collection.deleteMany({})).then((function(){}))}catch(e){return Promise.reject(e)}},r.initialize=function(){try{var t=function(e){return r.client=e,r.db=r.client.db(r.databaseName),Promise.resolve(u.createCollectionIfNotExist(r.db,r.collectionName)).then((function(e){r.collection=e}))},r=this,n=r.client;return Promise.resolve(n?t(n):Promise.resolve(e.MongoClient.connect(r.serverUrl,{useUnifiedTopology:!0,useNewUrlParser:!0})).then(t))}catch(e){return Promise.reject(e)}},t}(),m=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).collectionName="cas-cache",t}l(r,e);var n=r.prototype;return n.initialize=function(){try{var t=this;return Promise.resolve(e.prototype.initialize.call(t)).then((function(){return Promise.resolve(t.collection.createIndex({hash:1},{unique:!0})).then((function(){}))}))}catch(e){return Promise.reject(e)}},n.read=function(e){try{return Promise.resolve(this.collection.find({hash:e}).limit(1).toArray()).then((function(e){if(1===e.length){var r=e.pop();return{code:t.FetchResultCode.Success,content:r.content.buffer}}return{code:t.FetchResultCode.NotFound}}))}catch(e){return Promise.reject(e)}},n.write=function(e,t){try{var r=this;return Promise.resolve(s((function(){return Promise.resolve(r.collection.insertOne({hash:e,content:t})).then((function(){}))}),(function(e){if(11e3!==e.code)throw e})))}catch(e){return Promise.reject(e)}},r}(f),h=function(r){function n(){var e;return(e=r.apply(this,arguments)||this).collectionName="queued-operations",e}l(n,r);var o=n.prototype;return o.initialize=function(){try{var e=this;return Promise.resolve(r.prototype.initialize.call(e)).then((function(){return Promise.resolve(e.collection.createIndex({didUniqueSuffix:1},{unique:!0})).then((function(){}))}))}catch(e){return Promise.reject(e)}},o.enqueue=function(r,n){try{var o=this;return Promise.resolve(s((function(){var t={didUniqueSuffix:r,operationBufferBsonBinary:new e.Binary(n)};return Promise.resolve(o.collection.insertOne(t)).then((function(){}))}),(function(e){if(11e3===e.code)throw new t.SidetreeError(t.ErrorCode.BatchWriterAlreadyHasOperationForDid);throw e})))}catch(e){return Promise.reject(e)}},o.dequeue=function(e){try{var t=this;return e<=0?Promise.resolve([]):Promise.resolve(t.collection.find().sort({_id:1}).limit(e).toArray()).then((function(e){return Promise.resolve(t.collection.deleteMany({_id:{$lte:e[e.length-1]._id}})).then((function(){return e.map((function(e){return n.convertToQueuedOperationModel(e)}))}))}))}catch(e){return Promise.reject(e)}},o.peek=function(e){try{return e<=0?Promise.resolve([]):Promise.resolve(this.collection.find().sort({_id:1}).limit(e).toArray()).then((function(e){return e.map((function(e){return n.convertToQueuedOperationModel(e)}))}))}catch(e){return Promise.reject(e)}},o.contains=function(e){try{return Promise.resolve(this.collection.find({didUniqueSuffix:e}).limit(1).toArray()).then((function(e){return e.length>0}))}catch(e){return Promise.reject(e)}},n.convertToQueuedOperationModel=function(e){return{didUniqueSuffix:e.didUniqueSuffix,operationBuffer:e.operationBufferBsonBinary.buffer}},n}(f),d=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).collectionName="transactions",e}l(r,t);var n=r.prototype;return n.initialize=function(){try{var e=this;return Promise.resolve(t.prototype.initialize.call(e)).then((function(){return Promise.resolve(e.collection.createIndex({transactionNumber:1},{unique:!0})).then((function(){}))}))}catch(e){return Promise.reject(e)}},n.getTransactionsCount=function(){try{return Promise.resolve(this.collection.countDocuments())}catch(e){return Promise.reject(e)}},n.getTransaction=function(t){try{return Promise.resolve(this.collection.find({transactionNumber:e.Long.fromNumber(t)}).toArray()).then((function(e){if(0!==e.length)return e[0]}))}catch(e){return Promise.reject(e)}},n.getTransactionsLaterThan=function(t,r){try{var n=this,o=[],i=s((function(){var i;return i=void 0===t?n.collection.find():n.collection.find({transactionNumber:{$gt:e.Long.fromNumber(t)}}),r&&(i=i.limit(r)),i=i.sort({transactionNumber:1}),Promise.resolve(i.toArray()).then((function(e){o=e}))}),(function(e){console.error(e)}));return Promise.resolve(i&&i.then?i.then((function(){return o})):o)}catch(e){return Promise.reject(e)}},n.addTransaction=function(t){try{var r=this;return Promise.resolve(s((function(){var n={anchorString:t.anchorString,transactionNumber:e.Long.fromNumber(t.transactionNumber),transactionTime:t.transactionTime,transactionTimeHash:t.transactionTimeHash,transactionFeePaid:t.transactionFeePaid,normalizedTransactionFee:t.normalizedTransactionFee,writer:t.writer};return Promise.resolve(r.collection.insertOne(n)).then((function(){}))}),(function(e){if(11e3!==e.code)throw e})))}catch(e){return Promise.reject(e)}},n.getLastTransaction=function(){try{return Promise.resolve(this.collection.find().limit(1).sort({transactionNumber:-1}).toArray()).then((function(e){if(0!==e.length)return e[0]}))}catch(e){return Promise.reject(e)}},n.getExponentiallySpacedTransactions=function(){try{var e=[];return Promise.resolve(this.collection.find().sort({transactionNumber:1}).toArray()).then((function(t){for(var r=t.length-1,n=1;r>=0;)e.push(t[r]),r-=n,n*=2;return e}))}catch(e){return Promise.reject(e)}},n.removeTransactionsLaterThan=function(t){try{var r=function(r){return n?r:Promise.resolve(o.collection.deleteMany({transactionNumber:{$gt:e.Long.fromNumber(t)}})).then((function(){}))},n=!1,o=this,i=function(){if(void 0===t)return Promise.resolve(o.clearCollection()).then((function(){n=!0}))}();return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(e){return Promise.reject(e)}},n.getTransactions=function(){try{return Promise.resolve(this.collection.find().sort({transactionNumber:1}).toArray())}catch(e){return Promise.reject(e)}},n.getTransactionsStartingFrom=function(t,r){try{var n;return n=this.collection.find(t===r?{transactionTime:{$eq:e.Long.fromNumber(t)}}:{$and:[{transactionTime:{$gte:e.Long.fromNumber(t)}},{transactionTime:{$lt:e.Long.fromNumber(r)}}]}),Promise.resolve(n.sort({transactionNumber:1}).toArray())}catch(e){return Promise.reject(e)}},r}(f),v=function(t){function r(e,r,n){var o;return(o=t.call(this,e,r)||this).collectionName="unresolvable-transactions",o.exponentialDelayFactorInMilliseconds=6e4,o.maximumUnresolvableTransactionReturnCount=100,void 0!==n&&(o.exponentialDelayFactorInMilliseconds=n),o}l(r,t);var n=r.prototype;return n.initialize=function(){try{var e=this;return Promise.resolve(t.prototype.initialize.call(e)).then((function(){return Promise.resolve(e.collection.createIndex({transactionTime:1,transactionNumber:1},{unique:!0})).then((function(){return Promise.resolve(e.collection.createIndex({nextRetryTime:1})).then((function(){}))}))}))}catch(e){return Promise.reject(e)}},n.recordUnresolvableTransactionFetchAttempt=function(t){try{var r=this,n=t.transactionTime,o=t.transactionNumber,i={transactionTime:n,transactionNumber:e.Long.fromNumber(o)};return Promise.resolve(r.collection.find(i).toArray()).then((function(i){var c;i&&i.length>0&&(c=i[0]);var a=function(){if(void 0===c){var i={transactionTime:n,transactionNumber:e.Long.fromNumber(o),anchorString:t.anchorString,transactionTimeHash:t.transactionTimeHash,firstFetchTime:Date.now(),retryAttempts:0,nextRetryTime:Date.now()};return Promise.resolve(r.collection.insertOne(i)).then((function(){}))}var a=c.retryAttempts+1,s=t.anchorString,u=Math.pow(2,c.retryAttempts)*r.exponentialDelayFactorInMilliseconds;console.info("Record transaction "+o+" with anchor string "+s+" to retry after "+u/1e3+" seconds.");var l=c.firstFetchTime+u,f={transactionTime:n,transactionNumber:e.Long.fromNumber(o)};return Promise.resolve(r.collection.updateOne(f,{$set:{retryAttempts:a,nextRetryTime:l}})).then((function(){}))}();if(a&&a.then)return a.then((function(){}))}))}catch(e){return Promise.reject(e)}},n.removeUnresolvableTransaction=function(t){try{return Promise.resolve(this.collection.deleteOne({transactionTime:t.transactionTime,transactionNumber:e.Long.fromNumber(t.transactionNumber)})).then((function(){}))}catch(e){return Promise.reject(e)}},n.getUnresolvableTransactionsDueForRetry=function(e){try{var t=this.maximumUnresolvableTransactionReturnCount;void 0!==e&&(t=e);var r=Date.now();return Promise.resolve(this.collection.find({nextRetryTime:{$lte:r}}).sort({nextRetryTime:1}).limit(t).toArray())}catch(e){return Promise.reject(e)}},n.removeUnresolvableTransactionsLaterThan=function(t){try{var r=function(r){return n?r:Promise.resolve(o.collection.deleteMany({transactionNumber:{$gt:e.Long.fromNumber(t)}})).then((function(){}))},n=!1,o=this,i=function(){if(void 0===t)return Promise.resolve(o.clearCollection()).then((function(){n=!0}))}();return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(e){return Promise.reject(e)}},n.getUnresolvableTransactions=function(){try{return Promise.resolve(this.collection.find().sort({transactionTime:1,transactionNumber:1}).toArray())}catch(e){return Promise.reject(e)}},r}(f),y=function(e,t,r,n,o,i){this.didUniqueSuffix=e,this.type=t,this.operationBuffer=r,this.transactionTime=n,this.transactionNumber=o,this.operationIndex=i};n.__decorate([r.PrimaryColumn(),r.ObjectIdColumn(),n.__metadata("design:type",String)],y.prototype,"_id",void 0),n.__decorate([r.Column(),n.__metadata("design:type",String)],y.prototype,"didUniqueSuffix",void 0),n.__decorate([r.Column(),n.__metadata("design:type",String)],y.prototype,"type",void 0),n.__decorate([r.Column(),n.__metadata("design:type",Buffer)],y.prototype,"operationBuffer",void 0),n.__decorate([r.Column(),n.__metadata("design:type",Number)],y.prototype,"transactionTime",void 0),n.__decorate([r.Column(),n.__metadata("design:type",Number)],y.prototype,"transactionNumber",void 0),n.__decorate([r.Column(),n.__metadata("design:type",Number)],y.prototype,"operationIndex",void 0);var p=y=n.__decorate([r.Entity(),n.__metadata("design:paramtypes",[String,String,Buffer,Number,Number,Number])],y),P=function(){function e(e,t){this.serverUrl=e,this.databaseName=t||"sidetree"}var n=e.prototype;return n.initialize=function(){try{var e=this;return Promise.resolve(r.createConnection({name:""+Date.now(),type:"mongodb",useNewUrlParser:!0,useUnifiedTopology:!0,url:""+e.serverUrl+e.databaseName,entities:[p]})).then((function(t){e.connection=t,e.repo=t.getMongoRepository(p)}))}catch(e){return Promise.reject(e)}},n.close=function(){try{return Promise.resolve(this.connection.close())}catch(e){return Promise.reject(e)}},n.put=function(e){try{var t=function(){var e=function(){if(s.length>0)return Promise.resolve(r.repo.insertMany(s)).then((function(){}))}();if(e&&e.then)return e.then((function(){}))},r=this,n=e.reduce((function(e,t){return e.find((function(e){return e.operationIndex===t.operationIndex}))?e:[].concat(e,[t])}),[]),s=[],u=function(e,t,r){if("function"==typeof e[a]){var n,s,u,l=e[a]();if(function e(r){try{for(;!(n=l.next()).done;)if((r=t(n.value))&&r.then){if(!c(r))return void r.then(e,u||(u=i.bind(null,s=new o,2)));r=r.v}s?i(s,1,r):s=r}catch(e){i(s||(s=new o),2,e)}}(),l.return){var f=function(e){try{n.done||l.return()}catch(e){}return e};if(s&&s.then)return s.then(f,(function(e){throw f(e)}));f()}return s}if(!("length"in e))throw new TypeError("Object is not iterable");for(var m=[],h=0;h<e.length;h++)m.push(e[h]);return function(e,t,r){var n,a,s=-1;return function r(u){try{for(;++s<e.length;)if((u=t(s))&&u.then){if(!c(u))return void u.then(r,a||(a=i.bind(null,n=new o,2)));u=u.v}n?i(n,1,u):n=u}catch(e){i(n||(n=new o),2,e)}}(),n}(m,(function(e){return t(m[e])}))}(n,(function(e){var t=e;return Promise.resolve(r.get(t.didUniqueSuffix)).then((function(e){e.find((function(e){return e.operationIndex===t.operationIndex&&e.transactionNumber===t.transactionNumber}))||s.push(t)}))}));return Promise.resolve(u&&u.then?u.then(t):t())}catch(e){return Promise.reject(e)}},n.get=function(e){try{return Promise.resolve(this.repo.find({didUniqueSuffix:e})).then((function(e){return e.sort((function(e,t){return e.operationIndex-t.operationIndex})),e}))}catch(e){return Promise.reject(e)}},n.delete=function(e){try{var t=e?Promise.resolve(this.repo.deleteMany({transactionNumber:{$gt:e}})).then((function(){})):Promise.resolve(this.repo.deleteMany({})).then((function(){}));return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},n.deleteUpdatesEarlierThan=function(e,r,n){try{return Promise.resolve(this.repo.deleteMany({$or:[{didUniqueSuffix:e,transactionNumber:{$lt:r},type:t.OperationType.Update},{didUniqueSuffix:e,transactionNumber:r,operationIndex:{$lt:n},type:t.OperationType.Update}]})).then((function(){}))}catch(e){return Promise.reject(e)}},e}();exports.MongoDb=u,exports.MongoDbCasCache=m,exports.MongoDbOperationQueue=h,exports.MongoDbTransactionStore=d,exports.MongoDbUnresolvableTransactionStore=v,exports.OperationStore=P;
//# sourceMappingURL=db.cjs.production.min.js.map
